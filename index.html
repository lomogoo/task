<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ê•≠ÂãôÁÆ°ÁêÜ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ - Rick's</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      border-bottom: 1px solid #e2e8f0;
      background-color: white;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    header p {
      font-size: 14px;
      color: #64748b;
    }

    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 256px;
      border-right: 1px solid #e2e8f0;
      background-color: #f1f5f9;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .sidebar-title {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      font-size: 14px;
      color: #475569;
    }

    .sidebar-title button:hover {
      background-color: #e2e8f0;
    }

    .client-item {
      margin-bottom: 8px;
    }

    .client-header-container {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .client-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      cursor: pointer;
      background: none;
      border: none;
      flex: 1;
      transition: background-color 0.2s;
    }

    .client-header:hover {
      background-color: #e2e8f0;
    }

    .client-header .chevron {
      transition: transform 0.2s;
      width: 16px;
      height: 16px;
    }

    .client-header.collapsed .chevron {
      transform: rotate(-90deg);
    }

    .client-count {
      font-size: 12px;
      color: #64748b;
      margin-left: auto;
    }

    .client-edit-btn,
    .client-delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 12px;
    }

    .client-edit-btn {
      color: #475569;
    }

    .client-delete-btn {
      color: #ef4444;
    }

    .client-item:hover .client-edit-btn,
    .client-item:hover .client-delete-btn {
      opacity: 1;
    }

    .client-edit-btn:hover {
      background-color: #cbd5e1;
    }

    .client-delete-btn:hover {
      background-color: #fee2e2;
    }

    .projects-list {
      margin-left: 8px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .project-btn-container {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .project-btn {
      text-align: left;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      background: none;
      color: #475569;
      display: flex;
      align-items: center;
      justify-content: space-between;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .project-btn:hover {
      background-color: #e2e8f0;
    }

    .project-btn.active {
      background-color: #3b82f6;
      color: white;
      font-weight: 600;
    }

    .project-btn .project-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .project-edit-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      color: #475569;
      font-size: 12px;
    }

    .project-btn-container:hover .project-edit-btn {
      opacity: 1;
    }

    .project-edit-btn:hover {
      background-color: #cbd5e1;
    }

    .project-add-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      color: #475569;
      font-size: 14px;
    }

    .project-btn-container:hover .project-add-btn {
      opacity: 1;
    }

    .project-add-btn:hover {
      background-color: #cbd5e1;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .controls-bar {
      border-bottom: 1px solid #e2e8f0;
      background-color: white;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .view-toggle {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .view-toggle label {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
    }

    .view-btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background-color: white;
      color: #475569;
      transition: all 0.2s;
    }

    .view-btn:hover {
      background-color: #f1f5f9;
    }

    .view-btn.active {
      background-color: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    .today-display {
      font-size: 14px;
      color: #64748b;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 16px;
      color: #64748b;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e2e8f0;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .gantt-section {
      padding: 24px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .gantt-section-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }

    .gantt-title-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .gantt-title {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
    }

    .gantt-title-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
      color: #475569;
      font-weight: 600;
    }

    .gantt-title-btn:hover {
      background-color: #e2e8f0;
    }

    .gantt-container {
      flex: 1;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background-color: white;
      position: relative;
    }

    .gantt-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f1f5f9;
      border-bottom: 1px solid #e2e8f0;
    }

    .gantt-header-row {
      display: flex;
    }

    .gantt-header-cell {
      width: 192px;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #64748b;
      border-right: 2px solid #cbd5e1;
      flex-shrink: 0;
      position: sticky;
      left: 0;
      background-color: #f1f5f9;
      z-index: 20;
      box-shadow: 2px 0 4px rgba(0,0,0,0.05);
    }

    .gantt-dates-header {
      display: flex;
      flex-shrink: 0;
      flex: 1;
    }

    .gantt-month-row {
      display: flex;
      border-bottom: 1px solid #e2e8f0;
    }

    .gantt-month-header {
      text-align: center;
      border-right: 1px solid #e2e8f0;
      font-size: 12px;
      color: #64748b;
      padding: 6px 4px;
      font-weight: 600;
      background-color: #f8fafc;
    }

    .gantt-day-row {
      display: flex;
    }

    .gantt-date-header {
      width: 32px;
      text-align: center;
      border-right: 1px solid #e2e8f0;
      font-size: 12px;
      color: #64748b;
      padding: 8px 4px;
      flex-shrink: 0;
    }

    .gantt-date-header.today {
      background-color: #dbeafe;
      color: #1e40af;
      font-weight: 700;
    }

    .gantt-date-header.saturday {
      background-color: #eff6ff;
      color: #1e40af;
    }

    .gantt-date-header.sunday,
    .gantt-date-header.holiday {
      background-color: #fef2f2;
      color: #dc2626;
    }

    .gantt-date-cell.saturday {
      background-color: #eff6ff;
    }

    .gantt-date-cell.sunday,
    .gantt-date-cell.holiday {
      background-color: #fef2f2;
    }

    .gantt-body {
      display: flex;
      flex-direction: column;
    }

    .gantt-row {
      display: flex;
      border-bottom: 1px solid #f1f5f9;
      min-height: 40px;
      position: relative;
    }

    .gantt-row:hover {
      background-color: #f8fafc;
    }

    .gantt-row.drag-over {
      border-top: 3px solid #3b82f6;
    }

    .gantt-cell {
      width: 192px;
      padding: 12px;
      border-right: 2px solid #cbd5e1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      position: sticky;
      left: 0;
      background-color: white;
      z-index: 5;
      box-shadow: 2px 0 4px rgba(0,0,0,0.05);
    }

    .gantt-cell.main-task {
      background-color: #f1f5f9;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 8px;
      border-right: 2px solid #cbd5e1;
    }

    .gantt-cell.main-task span {
      flex: 1;
    }

    .gantt-cell.sub-task {
      padding-left: 32px;
      color: #475569;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .gantt-cell.sub-task span {
      flex: 1;
    }

    .gantt-cell.subtask-header {
      padding-left: 24px;
      background-color: #f8fafc;
      font-weight: 500;
      color: #334155;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      position: sticky;
      left: 0;
      z-index: 5;
      border-right: 2px solid #cbd5e1;
      box-shadow: 2px 0 4px rgba(0,0,0,0.05);
    }

    .gantt-cell.subtask-header span {
      flex: 1;
    }

    .gantt-cell.task-item {
      padding-left: 48px;
      background-color: white;
      color: #64748b;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      position: sticky;
      left: 0;
      z-index: 5;
    }

    .gantt-add-btn,
    .gantt-edit-btn,
    .gantt-delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 12px;
      flex-shrink: 0;
    }

    .gantt-row:hover .gantt-add-btn,
    .gantt-row:hover .gantt-edit-btn,
    .gantt-row:hover .gantt-delete-btn {
      opacity: 1;
    }

    .gantt-add-btn {
      color: #10b981;
    }

    .gantt-add-btn:hover {
      background-color: #d1fae5;
    }

    .gantt-edit-btn {
      color: #3b82f6;
    }

    .gantt-edit-btn:hover {
      background-color: #dbeafe;
    }

    .gantt-delete-btn {
      color: #ef4444;
    }

    .gantt-delete-btn:hover {
      background-color: #fee2e2;
    }

    .gantt-dates-row {
      display: flex;
      position: relative;
      flex: 1;
      flex-shrink: 0;
      z-index: 1;
    }

    .gantt-date-cell {
      width: 32px;
      border-right: 1px solid #e2e8f0;
      position: relative;
      flex-shrink: 0;
      cursor: pointer;
    }

    .gantt-date-cell:hover {
      background-color: #f0f9ff;
    }

    .gantt-date-cell.today {
      background-color: #f0f9ff;
    }

    .gantt-bars-container {
      position: absolute;
      top: 4px;
      left: 0;
      right: 0;
      height: 32px;
      pointer-events: none;
    }

    .gantt-bars-container-multi {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      pointer-events: none;
    }

    .gantt-bar {
      position: absolute;
      height: 28px;
      border-radius: 4px;
      cursor: move;
      display: flex;
      align-items: center;
      padding: 0 8px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: opacity 0.2s;
      pointer-events: auto;
      top: 0;
      border: 2px solid transparent;
      user-select: none;
    }

    .gantt-bar:hover {
      opacity: 0.9;
      border-color: rgba(255, 255, 255, 0.5);
    }

    .gantt-bar-resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 8px;
      cursor: ew-resize;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 0 4px 4px 0;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .gantt-bar:hover .gantt-bar-resize-handle {
      opacity: 1;
    }

    .gantt-bar.completed {
      background-color: #10b981;
    }

    .gantt-bar.in-progress {
      background-color: #3b82f6;
    }

    .gantt-bar.pending {
      background-color: #94a3b8;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }

    .badge.pending {
      background-color: #f1f5f9;
      color: #475569;
    }

    .badge.in-progress {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .badge.completed {
      background-color: #dcfce7;
      color: #166534;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background-color: #e2e8f0;
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: #3b82f6;
      transition: width 0.2s;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      border-bottom: 1px solid #e2e8f0;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 700;
      color: #0f172a;
      position: sticky;
      top: 0;
      background-color: white;
    }

    .modal-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      transition: color 0.2s;
      font-size: 18px;
    }

    .modal-close:hover {
      color: #0f172a;
    }

    .modal-content {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .progress-control {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .progress-input {
      width: 100%;
    }

    .progress-track {
      width: 100%;
      height: 6px;
      background-color: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-track-fill {
      height: 100%;
      background-color: #3b82f6;
      transition: width 0.2s;
    }

    .readonly-field {
      background-color: #f1f5f9;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      color: #475569;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2563eb;
    }

    .btn-secondary {
      background-color: #e2e8f0;
      color: #475569;
    }

    .btn-secondary:hover {
      background-color: #cbd5e1;
    }

    .btn-danger {
      background-color: #fecaca;
      color: #991b1b;
    }

    .btn-danger:hover {
      background-color: #fca5a5;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      flex: none;
      width: auto;
    }

    .empty-message {
      text-align: center;
      color: #94a3b8;
      padding: 24px;
      font-size: 14px;
    }

    .main-task-select-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .main-task-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .main-task-btn {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      background-color: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .main-task-btn:hover {
      border-color: #3b82f6;
      background-color: #f0f9ff;
    }

    .main-task-btn.selected {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .other-input {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }

    /* „É™„Çπ„ÉàË°®Á§∫ */
    .list-section {
      padding: 24px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .list-section-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }

    .list-title-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .list-title {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
    }

    .list-container {
      flex: 1;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background-color: white;
    }

    .task-table {
      width: 100%;
      border-collapse: collapse;
    }

    .task-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f1f5f9;
    }

    .task-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      color: #64748b;
      border-bottom: 1px solid #e2e8f0;
      white-space: nowrap;
    }

    .task-table td {
      padding: 12px;
      font-size: 14px;
      color: #475569;
      border-bottom: 1px solid #f1f5f9;
    }

    .task-row {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .task-row:hover {
      background-color: #f8fafc;
    }
  </style>
</head>
<body>
  <div id="app">
    <div v-if="isLoading" class="loading">
      <div class="spinner"></div>
      „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...
    </div>

    <template v-else>
      <header>
        <h1>Ê•≠ÂãôÁÆ°ÁêÜ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
        <p v-if="currentClient && currentProject">
          {{ currentClient.name }} / {{ currentProject.name }}
        </p>
      </header>

      <div class="main-container">
        <div class="sidebar">
          <div class="sidebar-title">
            <span>Ê°à‰ª∂‰∏ÄË¶ß</span>
            <button @click="openAddClientModal" title="„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíËøΩÂä†">+</button>
          </div>
          
          <div style="flex: 1; overflow-y: auto;">
            <div v-for="client in data.clients" :key="client.id" class="client-item">
              <div class="client-header-container">
                <button
                  @click="toggleClient(client.id)"
                  class="client-header"
                  :class="{ collapsed: !expandedClients[client.id] }"
                >
                  <span class="chevron">‚ñº</span>
                  <span>{{ client.name }}</span>
                  <span class="client-count">({{ getProjectsForClient(client.id).length }})</span>
                </button>
                <button
                  @click="openAddProjectModal(client.id)"
                  class="client-edit-btn"
                  title="Ê°à‰ª∂„ÇíËøΩÂä†"
                >+</button>
                <button
                  @click="openEditClientModal(client)"
                  class="client-edit-btn"
                  title="„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç„ÇíÁ∑®ÈõÜ"
                >‚úèÔ∏è</button>
                <button
                  @click="deleteClient(client)"
                  class="client-delete-btn"
                  title="„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíÂâäÈô§"
                >üóëÔ∏è</button>
              </div>

              <div v-if="expandedClients[client.id]" class="projects-list">
                <div v-for="project in getProjectsForClient(client.id)" :key="project.id" class="project-btn-container">
                  <button
                    @click="selectedProject = project.id"
                    class="project-btn"
                    :class="{ active: selectedProject === project.id }"
                  >
                    <span class="project-name">{{ project.name }}</span>
                  </button>
                  <button 
                    @click="openEditProjectModal(project)"
                    class="project-edit-btn"
                    title="Ê°à‰ª∂Âêç„ÇíÁ∑®ÈõÜ"
                  >‚úèÔ∏è</button>
                  <button 
                    @click="openAddMainTaskModal(project.id)"
                    class="project-add-btn"
                    title="Â§ßÂàÜÈ°û„ÇíËøΩÂä†"
                  >+</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="content">
          <div class="controls-bar">
            <div class="view-toggle">
              <label>Ë°®Á§∫„É¢„Éº„Éâ:</label>
              <button
                @click="viewMode = 'day'"
                class="view-btn"
                :class="{ active: viewMode === 'day' }"
              >
                „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà
              </button>
              <button
                @click="viewMode = 'list'"
                class="view-btn"
                :class="{ active: viewMode === 'list' }"
              >
                „É™„Çπ„ÉàË°®Á§∫
              </button>
              <button
                @click="viewMode = 'todo'"
                class="view-btn"
                :class="{ active: viewMode === 'todo' }"
              >
                ToDo„É™„Çπ„Éà
              </button>
            </div>
            <div class="today-display">Êú¨Êó•: {{ today }}</div>
          </div>

          <!-- „Ç¨„É≥„Éà„ÉÅ„É£„Éº„ÉàË°®Á§∫ -->
          <div v-if="viewMode === 'day'" class="gantt-section">
            <div class="gantt-section-inner">
              <div class="gantt-title-row">
<h2 class="gantt-title">„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà</h2>
                <button @click="openAddMainTaskModal(selectedProject)" class="gantt-title-btn" title="Â§ßÂàÜÈ°û„ÇíËøΩÂä†">+ Â§ßÂàÜÈ°ûËøΩÂä†</button>
                <button @click="openAddTaskModal(currentMainTasks[0]?.id)" class="gantt-title-btn" title="„Çø„Çπ„ÇØ„ÇíËøΩÂä†">+ „Çø„Çπ„ÇØËøΩÂä†</button>
              </div>
              <div class="gantt-container" ref="ganttContainer">
                <div class="gantt-header">
                  <!-- Êúà/ÈÄ±Ë°®Á§∫Ë°å -->
                  <div class="gantt-header-row gantt-month-row">
                    <div class="gantt-header-cell">„Çø„Çπ„ÇØ</div>
                    <div class="gantt-dates-header">
                      <template v-if="viewMode === 'day'">
                        <div
                          v-for="(group, idx) in monthGroups"
                          :key="idx"
                          class="gantt-month-header"
                          :style="{ width: (group.count * 32) + 'px' }"
                        >
                          {{ group.label }}
                        </div>
                      </template>
                      <template v-else>
                        <div
                          v-for="(group, idx) in weekGroups"
                          :key="idx"
                          class="gantt-month-header"
                          :style="{ width: (group.count * 224) + 'px' }"
                        >
                          {{ group.label }}
                        </div>
                      </template>
                    </div>
                  </div>
                  <!-- Êó•/ÈÄ±Ë°®Á§∫Ë°å -->
                  <div class="gantt-header-row gantt-day-row">
                    <div class="gantt-header-cell" style="border-top: 1px solid #e2e8f0;"></div>
                    <div class="gantt-dates-header">
                      <template v-if="viewMode === 'day'">
                        <div
                          v-for="(date, idx) in headerDates"
                          :key="idx"
                          class="gantt-date-header"
                          :class="getDayClass(date, idx)"
                        >
                          {{ date.getDate() }}
                        </div>
                      </template>
                      <template v-else>
                        <div
                          v-for="(week, idx) in displayDates"
                          :key="idx"
                          class="gantt-date-header"
                          :style="{ width: '224px' }"
                        >
                          {{ getWeekLabel(week) }}
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <div class="gantt-body">
                  <template v-for="mainTask in currentMainTasks" :key="mainTask.id">
                    <!-- Â§ßÂàÜÈ°û„ÅÆË°åÔºà„Çø„Ç§„Éà„É´„ÅÆ„Åø„ÄÅ„Çø„Çπ„ÇØ„Éê„Éº„Å™„ÅóÔºâ -->
                    <div
                      class="gantt-row"
                      :class="{ 'drag-over': dragOverItem === mainTask.id }"
                      draggable="true"
                      @dragstart="startDraggingMainTask($event, mainTask)"
                      @dragover.prevent="onDragOverMainTask($event, mainTask)"
                      @drop="onDropMainTask($event, mainTask)"
                      @dragend="draggingMainTask = null; dragOverItem = null"
                    >
                      <div class="gantt-cell main-task">
                        <span>{{ mainTask.title }}</span>
                        <button @click="openAddSubtaskModal(mainTask.id)" class="gantt-add-btn" title="Â∞èÂàÜÈ°û„ÇíËøΩÂä†">+</button>
                        <button @click="openEditMainTaskModal(mainTask)" class="gantt-edit-btn" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                        <button @click="deleteMainTask(mainTask)" class="gantt-delete-btn" title="ÂâäÈô§">üóëÔ∏è</button>
                      </div>
                      <div class="gantt-dates-row">
                        <template v-if="viewMode === 'day'">
                          <div
                            v-for="(date, idx) in headerDates"
                            :key="idx"
                            class="gantt-date-cell"
                            :class="getDayClass(date, idx)"
                          ></div>
                        </template>
                        <template v-else>
                          <div
                            v-for="(week, idx) in displayDates"
                            :key="idx"
                            class="gantt-date-cell"
                            :style="{ width: '224px' }"
                          ></div>
                        </template>
                      </div>
                    </div>

                    <!-- Â∞èÂàÜÈ°û„ÅÆË°å -->
                    <template v-for="subtask in getSubtasksForMainTask(mainTask.id)" :key="subtask.id">
                      <div
                        class="gantt-row subtask-row-with-tasks"
                        :class="{ 'drag-over': dragOverItem === subtask.id }"
                        :style="{ minHeight: getSubtaskRowHeight(subtask.id) + 'px' }"
                      >
                        <div
                          class="gantt-cell subtask-header"
                          draggable="true"
                          @dragstart="startDraggingSubtask($event, subtask)"
                          @dragover.prevent="onDragOverSubtask($event, subtask)"
                          @drop="onDropSubtask($event, subtask)"
                          @dragend="draggingSubtask = null; dragOverItem = null"
                        >
                          <span>{{ subtask.title }}</span>
                          <button @click="openAddTaskModalForSubtask(subtask.id)" class="gantt-add-btn" title="„Çø„Çπ„ÇØ„ÇíËøΩÂä†">+</button>
                          <button @click="openEditSubtaskModal(subtask)" class="gantt-edit-btn" title="Á∑®ÈõÜ">‚úèÔ∏è</button>
                          <button @click="deleteSubtask(subtask)" class="gantt-delete-btn" title="ÂâäÈô§">üóëÔ∏è</button>
                        </div>
                        <div class="gantt-dates-row">
                          <template v-if="viewMode === 'day'">
                            <div
                              v-for="(date, idx) in headerDates"
                              :key="idx"
                              class="gantt-date-cell"
                              :class="getDayClass(date, idx)"
                              @click="openAddTaskModalWithDate(subtask.id, date)"
                            ></div>
                          </template>
                          <template v-else>
                            <div
                              v-for="(week, idx) in displayDates"
                              :key="idx"
                              class="gantt-date-cell"
                              :style="{ width: '224px' }"
                            ></div>
                          </template>
                          <!-- Â∞èÂàÜÈ°û„Å´Â±û„Åô„Çã„Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„Éê„Éº„ÇíË°®Á§∫ -->
                          <div class="gantt-bars-container-multi">
                            <div
                              v-for="(task, taskIdx) in getTasksForSubtask(subtask.id)"
                              :key="task.id"
                              class="gantt-bar"
                              :class="task.status"
                              :style="getTaskBarStyleWithOffset(task, taskIdx)"
                              :title="task.title"
                              @mousedown="startDraggingTask($event, task)"
                              @click="handleTaskClick(task)"
                            >
                              {{ task.title }}
                              <div
                                class="gantt-bar-resize-handle"
                                @mousedown.stop="startResizingTask($event, task)"
                              ></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <!-- „É™„Çπ„ÉàË°®Á§∫ -->
          <div v-else-if="viewMode === 'list'" class="list-section">
            <div class="list-section-inner">
              <div class="list-title-row">
                <h2 class="list-title">„Çø„Çπ„ÇØ‰∏ÄË¶ßÔºàÊúüÊó•È†ÜÔºâ</h2>
              </div>
              <div class="list-container">
                <table class="task-table">
                  <thead>
                    <tr>
                      <th>Â§ßÂàÜÈ°û</th>
                      <th>Â∞èÂàÜÈ°û</th>
                      <th>„Çø„Çπ„ÇØÂêç</th>
                      <th>ÈñãÂßãÊó•</th>
                      <th>ÁµÇ‰∫ÜÊó•</th>
                      <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                      <th>ÂÑ™ÂÖàÂ∫¶</th>
                      <th>ÈÄ≤Êçó</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      v-for="task in sortedTasksByDeadline"
                      :key="task.id"
                      @click="selectedTaskForDetail = task"
                      class="task-row"
                    >
                      <td>{{ getMainTaskTitle(task.maintaskid) }}</td>
                      <td>{{ getSubtaskTitle(task.subtaskid) }}</td>
                      <td>{{ task.title }}</td>
                      <td>{{ task.startdate }}</td>
                      <td>{{ task.enddate }}</td>
                      <td><span class="badge" :class="task.status">{{ getStatusLabel(task.status) }}</span></td>
                      <td>{{ task.priority }}</td>
                      <td>{{ task.progress }}%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- ToDo„É™„Çπ„ÉàË°®Á§∫ -->
          <div v-else-if="viewMode === 'todo'" class="list-section">
            <div class="list-section-inner">
              <div class="list-title-row">
                <h2 class="list-title">ToDo„É™„Çπ„Éà</h2>
                <button @click="showAddTodoModal = true" class="gantt-title-btn">+ ToDoËøΩÂä†</button>
              </div>
              <div class="list-container">
                <table class="task-table">
                  <thead>
                    <tr>
                      <th style="width: 60px;">ÂÆå‰∫Ü</th>
                      <th>„Çø„Çπ„ÇØ</th>
                      <th style="width: 120px;">ÊúüÊó•</th>
                      <th style="width: 100px;">Êìç‰Ωú</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      v-for="todo in data.todos.filter(t => t.projectid === selectedProject)"
                      :key="todo.id"
                      :class="{ 'todo-completed': todo.completed }"
                    >
                      <td style="text-align: center;">
                        <input type="checkbox" :checked="todo.completed" @change="toggleTodoComplete(todo)" />
                      </td>
                      <td :style="{ textDecoration: todo.completed ? 'line-through' : 'none' }">{{ todo.title }}</td>
                      <td>{{ todo.duedate || '-' }}</td>
                      <td>
                        <button @click="editingTodo = { ...todo }" class="btn btn-sm" style="padding: 4px 8px; font-size: 12px;">Á∑®ÈõÜ</button>
                        <button @click="deleteTodo(todo)" class="btn btn-sm" style="padding: 4px 8px; font-size: 12px; background: #ef4444;">ÂâäÈô§</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Task Detail Modal -->
      <div v-if="selectedTaskForDetail" class="modal-overlay" @click="selectedTaskForDetail = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>„Çø„Çπ„ÇØË©≥Á¥∞</span>
            <button @click="selectedTaskForDetail = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>„Çø„Çπ„ÇØÂêç</label>
              <input v-model="editingTask.title" type="text">
            </div>

            <div class="form-group">
              <label>Â§ßÂàÜÈ°û</label>
              <div class="readonly-field">{{ getMainTaskTitle(editingTask.maintaskid) }}</div>
            </div>

            <div class="form-group">
              <label>Â∞èÂàÜÈ°û</label>
              <div class="readonly-field">{{ getSubtaskTitle(editingTask.subtaskid) }}</div>
            </div>

            <div class="form-group">
              <label>„Çπ„ÉÜ„Éº„Çø„Çπ</label>
              <select v-model="editingTask.status">
                <option value="pending">Êú™ÁùÄÊâã</option>
                <option value="in-progress">ÈÄ≤Ë°å‰∏≠</option>
                <option value="completed">ÂÆå‰∫Ü</option>
              </select>
            </div>

            <div class="form-group">
              <label>ÂÑ™ÂÖàÂ∫¶</label>
              <select v-model="editingTask.priority">
                <option value="low">‰Ωé</option>
                <option value="medium">‰∏≠</option>
                <option value="high">È´ò</option>
              </select>
            </div>

            <div class="form-group progress-control">
              <label>ÈÄ≤Êçó: {{ editingTask.progress }}%</label>
              <input v-model.number="editingTask.progress" type="range" min="0" max="100" class="progress-input">
              <div class="progress-track">
                <div class="progress-track-fill" :style="{ width: editingTask.progress + '%' }"></div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>ÈñãÂßãÊó•</label>
                <input v-model="editingTask.startdate" type="date">
              </div>
              <div class="form-group">
                <label>ÁµÇ‰∫ÜÊó•</label>
                <input v-model="editingTask.enddate" type="date">
              </div>
            </div>

            <div class="form-group">
              <label>„É°„É¢</label>
              <textarea v-model="editingTask.notes" placeholder="„É°„É¢„ÇíÂÖ•Âäõ..."></textarea>
            </div>

            <div class="modal-actions">
              <button @click="saveTask" class="btn btn-primary">‰øùÂ≠ò</button>
              <button @click="deleteTask" class="btn btn-danger btn-small">ÂâäÈô§</button>
              <button @click="selectedTaskForDetail = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Task Modal -->
      <div v-if="showAddTaskModalForMain" class="modal-overlay" @click="showAddTaskModalForMain = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíËøΩÂä†</span>
            <button @click="showAddTaskModalForMain = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>Â§ßÂàÜÈ°û„ÇíÈÅ∏Êäû</label>
              <div class="main-task-select-group">
                <div class="main-task-buttons">
                  <button
                    v-for="mainTask in currentMainTasks"
                    :key="mainTask.id"
                    @click="newTaskForm.selectedMainTaskId = mainTask.id; newTaskForm.customMainTaskTitle = '';"
                    class="main-task-btn"
                    :class="{ selected: newTaskForm.selectedMainTaskId === mainTask.id }"
                  >
                    {{ mainTask.title }}
                  </button>
                  <button
                    @click="newTaskForm.selectedMainTaskId = 'other'"
                    class="main-task-btn"
                    :class="{ selected: newTaskForm.selectedMainTaskId === 'other' }"
                  >
                    „Åù„ÅÆ‰ªñ
                  </button>
                </div>
                <div v-if="newTaskForm.selectedMainTaskId === 'other'" class="other-input">
                  <label>Â§ßÂàÜÈ°ûÂêç„ÇíÂÖ•Âäõ</label>
                  <input v-model="newTaskForm.customMainTaskTitle" type="text" placeholder="Êñ∞„Åó„ÅÑÂ§ßÂàÜÈ°ûÂêç„ÇíÂÖ•Âäõ">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>„Çø„Çπ„ÇØÂêç *</label>
              <input v-model="newTaskForm.title" type="text" placeholder="„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>ÈñãÂßãÊó•</label>
                <input v-model="newTaskForm.startdate" type="date">
              </div>
              <div class="form-group">
                <label>ÁµÇ‰∫ÜÊó•</label>
                <input v-model="newTaskForm.enddate" type="date">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>ÂÑ™ÂÖàÂ∫¶</label>
                <select v-model="newTaskForm.priority">
                  <option value="low">‰Ωé</option>
                  <option value="medium">‰∏≠</option>
                  <option value="high">È´ò</option>
                </select>
              </div>
              <div class="form-group">
                <label>„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                <select v-model="newTaskForm.status">
                  <option value="pending">Êú™ÁùÄÊâã</option>
                  <option value="in-progress">ÈÄ≤Ë°å‰∏≠</option>
                  <option value="completed">ÂÆå‰∫Ü</option>
                </select>
              </div>
            </div>

            <div class="modal-actions">
              <button @click="addTask" class="btn btn-primary">ËøΩÂä†</button>
              <button @click="showAddTaskModalForMain = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Main Task Modal -->
      <div v-if="showAddMainTaskModal" class="modal-overlay" @click="showAddMainTaskModal = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>Â§ßÂàÜÈ°û„ÇíËøΩÂä†</span>
            <button @click="showAddMainTaskModal = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>Â§ßÂàÜÈ°ûÂêç *</label>
              <input v-model="newMainTaskForm.title" type="text" placeholder="Â§ßÂàÜÈ°ûÂêç„ÇíÂÖ•ÂäõÔºàËá™Áî±„Å´ÂÖ•ÂäõÂèØËÉΩÔºâ">
            </div>

            <div class="modal-actions">
              <button @click="addMainTask" class="btn btn-primary">ËøΩÂä†</button>
              <button @click="showAddMainTaskModal = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Subtask Modal -->
      <div v-if="showAddSubtaskModal" class="modal-overlay" @click="showAddSubtaskModal = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>Â∞èÂàÜÈ°û„ÇíËøΩÂä†</span>
            <button @click="showAddSubtaskModal = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>Â∞èÂàÜÈ°ûÂêç *</label>
              <input v-model="newSubtaskForm.title" type="text" placeholder="Â∞èÂàÜÈ°ûÂêç„ÇíÂÖ•Âäõ">
            </div>

            <div class="modal-actions">
              <button @click="addSubtask" class="btn btn-primary">ËøΩÂä†</button>
              <button @click="showAddSubtaskModal = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Main Task Modal -->
      <div v-if="editingMainTask" class="modal-overlay" @click="editingMainTask = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>Â§ßÂàÜÈ°û„ÇíÁ∑®ÈõÜ</span>
            <button @click="editingMainTask = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>Â§ßÂàÜÈ°ûÂêç</label>
              <input v-model="editingMainTask.title" type="text">
            </div>

            <div class="modal-actions">
              <button @click="updateMainTask" class="btn btn-primary">‰øùÂ≠ò</button>
              <button @click="editingMainTask = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Subtask Modal -->
      <div v-if="editingSubtask" class="modal-overlay" @click="editingSubtask = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>Â∞èÂàÜÈ°û„ÇíÁ∑®ÈõÜ</span>
            <button @click="editingSubtask = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>Â∞èÂàÜÈ°ûÂêç</label>
              <input v-model="editingSubtask.title" type="text">
            </div>

            <div class="modal-actions">
              <button @click="updateSubtask" class="btn btn-primary">‰øùÂ≠ò</button>
              <button @click="editingSubtask = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Client Modal -->
      <div v-if="showAddClientModal" class="modal-overlay" @click="showAddClientModal = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíËøΩÂä†</span>
            <button @click="showAddClientModal = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç *</label>
              <input v-model="newClientForm.name" type="text" placeholder="„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç„ÇíÂÖ•Âäõ">
            </div>

            <div class="modal-actions">
              <button @click="addClient" class="btn btn-primary">ËøΩÂä†</button>
              <button @click="showAddClientModal = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Ê°à‰ª∂ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
      <div v-if="showAddProjectModal" class="modal-overlay" @click="showAddProjectModal = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>Ê°à‰ª∂„ÇíËøΩÂä†</span>
            <button @click="showAddProjectModal = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>Ê°à‰ª∂Âêç *</label>
              <input v-model="newProjectForm.name" type="text" placeholder="Ê°à‰ª∂Âêç„ÇíÂÖ•Âäõ" @keyup.enter="addProject">
            </div>

            <div class="modal-actions">
              <button @click="addProject" class="btn btn-primary">ËøΩÂä†</button>
              <button @click="showAddProjectModal = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ToDoËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
      <div v-if="showAddTodoModal" class="modal-overlay" @click="showAddTodoModal = false">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>ToDoËøΩÂä†</span>
            <button @click="showAddTodoModal = false" class="modal-close">‚úï</button>
          </div>
          <div class="modal-content">
            <div class="form-group">
              <label>„Çø„Çπ„ÇØÂêç *</label>
              <input v-model="newTodoForm.title" type="text" placeholder="„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ" @keyup.enter="addTodo">
            </div>
            <div class="form-group">
              <label>ÊúüÊó•</label>
              <input v-model="newTodoForm.duedate" type="date">
            </div>
            <div class="modal-actions">
              <button @click="addTodo" class="btn btn-primary">ËøΩÂä†</button>
              <button @click="showAddTodoModal = false" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ToDoÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
      <div v-if="editingTodo" class="modal-overlay" @click="editingTodo = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>ToDoÁ∑®ÈõÜ</span>
            <button @click="editingTodo = null" class="modal-close">‚úï</button>
          </div>
          <div class="modal-content">
            <div class="form-group">
              <label>„Çø„Çπ„ÇØÂêç *</label>
              <input v-model="editingTodo.title" type="text">
            </div>
            <div class="form-group">
              <label>ÊúüÊó•</label>
              <input v-model="editingTodo.duedate" type="date">
            </div>
            <div class="modal-actions">
              <button @click="updateTodo" class="btn btn-primary">Êõ¥Êñ∞</button>
              <button @click="editingTodo = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Client Modal -->
      <div v-if="editingClient" class="modal-overlay" @click="editingClient = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç„ÇíÁ∑®ÈõÜ</span>
            <button @click="editingClient = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç</label>
              <input v-model="editingClient.name" type="text">
            </div>

            <div class="modal-actions">
              <button @click="updateClient" class="btn btn-primary">‰øùÂ≠ò</button>
              <button @click="editingClient = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Project Modal -->
      <div v-if="editingProject" class="modal-overlay" @click="editingProject = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>Ê°à‰ª∂Âêç„ÇíÁ∑®ÈõÜ</span>
            <button @click="editingProject = null" class="modal-close">‚úï</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>Ê°à‰ª∂Âêç</label>
              <input v-model="editingProject.name" type="text">
            </div>
            <div class="form-group">
              <label>Ë™¨Êòé</label>
              <textarea v-model="editingProject.description" placeholder="Ë™¨Êòé„ÇíÂÖ•Âäõ..."></textarea>
            </div>

            <div class="modal-actions">
              <button @click="updateProject" class="btn btn-primary">‰øùÂ≠ò</button>
              <button @click="editingProject = null" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>

  <script>
    const { createApp } = Vue;
    const { createClient } = window.supabase;

    const SUPABASE_URL = 'https://dsuiaaaxwwvhiqktgvoi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzdWlhYWF4d3d2aGlxa3Rndm9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxODcxODQsImV4cCI6MjA3ODc2MzE4NH0.ng7SlvSE25Ef_EZZeTe5F2tGcHNco1x1iZ_Nx4ewohg';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // UUIDÁîüÊàêÈñ¢Êï∞
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    createApp({
      data() {
        return {
          data: {
            clients: [],
            projects: [],
            maintasks: [],
            subtasks: [],
            tasks: [],
            todos: []
          },
          isLoading: true,
          selectedProject: 'p1',
          selectedTaskForDetail: null,
          editingTask: {},
          editingClient: null,
          editingProject: null,
          viewMode: 'day',
          expandedClients: {},
          showAddTaskModalForMain: null,
          showAddMainTaskModal: null,
          showAddSubtaskModal: null,
          showAddClientModal: false,
          showAddProjectModal: null,
          editingMainTask: null,
          editingSubtask: null,
          newTaskForm: {
            title: '',
            startdate: '',
            enddate: '',
            priority: 'medium',
            status: 'pending',
            selectedMainTaskId: null,
            selectedSubtaskId: null,
            customMainTaskTitle: ''
          },
          newMainTaskForm: {
            title: ''
          },
          newSubtaskForm: {
            title: ''
          },
          newClientForm: {
            name: ''
          },
          newProjectForm: {
            name: ''
          },
          newTodoForm: {
            title: '',
            duedate: '',
            projectid: null
          },
          showAddTodoModal: false,
          editingTodo: null,
          draggingTask: null,
          resizingTask: null,
          dragStartX: 0,
          dragStartY: 0,
          dragStartDate: null,
          resizeStartWidth: 0,
          isDragging: false,
          draggingMainTask: null,
          draggingSubtask: null,
          dragOverItem: null
        };
      },
      computed: {
        today() {
          const d = new Date();
          return d.toISOString().split('T')[0];
        },
        currentClient() {
          const project = this.data.projects.find(p => p.id === this.selectedProject);
          return project ? this.data.clients.find(c => c.id === project.clientid) : null;
        },
        currentProject() {
          return this.data.projects.find(p => p.id === this.selectedProject);
        },
        currentMainTasks() {
          return this.data.maintasks
            .filter(m => m.projectid === this.selectedProject)
            .sort((a, b) => a.order - b.order);
        },
        projectTasks() {
          const mainTaskIds = this.currentMainTasks.map(m => m.id);
          return this.data.tasks.filter(t => mainTaskIds.includes(t.maintaskid));
        },
        headerDates() {
          const dates = [];
          let startDate, endDate;

          // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Çø„Çπ„ÇØ„Åã„ÇâÊúÄ„ÇÇÊó©„ÅÑÊó•‰ªò„Å®ÊúÄ„ÇÇÈÅÖ„ÅÑÊó•‰ªò„ÇíÂèñÂæó
          if (this.projectTasks.length > 0) {
            const earliestTask = this.projectTasks.reduce((earliest, task) => {
              const taskDate = new Date(task.startdate);
              return taskDate < new Date(earliest.startdate) ? task : earliest;
            });
            const latestTask = this.projectTasks.reduce((latest, task) => {
              const taskDate = new Date(task.enddate);
              return taskDate > new Date(latest.enddate) ? task : latest;
            });

            startDate = new Date(earliestTask.startdate);
            startDate.setDate(startDate.getDate() - 30); // ÊúÄÂàù„ÅÆ„Çø„Çπ„ÇØ„ÅÆ30Êó•Ââç„Åã„ÇâÈñãÂßã

            endDate = new Date(latestTask.enddate);
            endDate.setDate(endDate.getDate() + 180); // ÊúÄÂæå„ÅÆ„Çø„Çπ„ÇØ„ÅÆ180Êó•Âæå„Åæ„ÅßË°®Á§∫

            // ÊúÄ‰Ωé„Åß„ÇÇ‰ªäÊó•„Åã„Çâ1Âπ¥ÂÖà„Åæ„ÅßË°®Á§∫
            const oneYearFromToday = new Date(this.today);
            oneYearFromToday.setFullYear(oneYearFromToday.getFullYear() + 1);
            if (endDate < oneYearFromToday) {
              endDate = oneYearFromToday;
            }
          } else {
            // „Çø„Çπ„ÇØ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰ªäÊó•„ÅÆ30Êó•Ââç„Åã„Çâ1Âπ¥ÂÖà„Åæ„ÅßË°®Á§∫
            startDate = new Date(this.today);
            startDate.setDate(startDate.getDate() - 30);
            endDate = new Date(this.today);
            endDate.setFullYear(endDate.getFullYear() + 1);
          }

          // startDate„Åã„ÇâendDate„Åæ„Åß„ÅÆÂÖ®„Å¶„ÅÆÊó•‰ªò„ÇíÁîüÊàê
          const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
          for (let i = 0; i <= daysDiff; i++) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            dates.push(date);
          }
          return dates;
        },
        todayOffset() {
          if (this.headerDates.length === 0) return 0;
          const startDate = this.headerDates[0];
          const diffTime = new Date(this.today) - startDate;
          return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        },
        monthGroups() {
          const groups = [];
          let currentMonth = null;
          let currentGroup = null;

          this.headerDates.forEach((date, idx) => {
            const monthYear = `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà`;
            if (monthYear !== currentMonth) {
              if (currentGroup) {
                groups.push(currentGroup);
              }
              currentMonth = monthYear;
              currentGroup = { label: monthYear, count: 1 };
            } else {
              currentGroup.count++;
            }
          });

          if (currentGroup) {
            groups.push(currentGroup);
          }

          return groups;
        },
        weekGroups() {
          const weeks = [];
          if (this.headerDates.length === 0) return weeks;

          let currentWeekStart = null;
          let currentWeek = null;

          this.headerDates.forEach((date, idx) => {
            const weekStart = this.getWeekStart(date);
            const weekKey = weekStart.toISOString().split('T')[0];

            if (weekKey !== currentWeekStart) {
              if (currentWeek) {
                weeks.push(currentWeek);
              }
              currentWeekStart = weekKey;
              currentWeek = {
                label: this.getWeekLabel(weekStart),
                count: 1,
                startDate: weekStart
              };
            } else {
              currentWeek.count++;
            }
          });

          if (currentWeek) {
            weeks.push(currentWeek);
          }

          return weeks;
        },
        displayDates() {
          if (this.viewMode === 'week') {
            // ÈÄ±Âçò‰ΩçË°®Á§∫„ÅÆÂ†¥Âêà„ÅØÈÄ±„ÅÆÈñãÂßãÊó•„ÅÆ„Åø„ÇíË°®Á§∫
            const weeks = [];
            let currentWeekStart = null;

            this.headerDates.forEach(date => {
              const weekStart = this.getWeekStart(date);
              const weekKey = weekStart.toISOString().split('T')[0];

              if (weekKey !== currentWeekStart) {
                weeks.push(weekStart);
                currentWeekStart = weekKey;
              }
            });

            return weeks;
          }
          return this.headerDates;
        },
        cellWidth() {
          return this.viewMode === 'week' ? 224 : 32; // ÈÄ±Âçò‰Ωç„ÅØ224px„ÄÅÊó•Âçò‰Ωç„ÅØ32px
        },
        sortedTasksByDeadline() {
          return [...this.projectTasks].sort((a, b) => {
            const dateA = new Date(a.enddate);
            const dateB = new Date(b.enddate);
            return dateA - dateB;
          });
        }
      },
      methods: {
        async loadData() {
          try {
            const [clientsRes, projectsRes, maintasksRes, subtasksRes, tasksRes, todosRes] = await Promise.all([
              supabase.from('clients').select('*'),
              supabase.from('projects').select('*'),
              supabase.from('maintasks').select('*'),
              supabase.from('subtasks').select('*'),
              supabase.from('tasks').select('*'),
              supabase.from('todos').select('*')
            ]);

            this.data.clients = clientsRes.data || [];
            this.data.projects = projectsRes.data || [];
            this.data.maintasks = maintasksRes.data || [];
            this.data.subtasks = subtasksRes.data || [];
            this.data.tasks = tasksRes.data || [];
            this.data.todos = todosRes.data || [];

            this.expandedClients[this.data.clients[0]?.id] = true;
            this.newTaskForm.startdate = this.today;
            this.newTaskForm.enddate = this.today;
            this.isLoading = false;

            // „Éá„Éº„Çø„É≠„Éº„ÉâÂæå„Å´„Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„Çí‰ªäÊó•„ÅÆÊó•‰ªò„Å´„Çπ„ÇØ„É≠„Éº„É´
            this.$nextTick(() => {
              if (this.$refs.ganttContainer) {
                const scrollLeft = this.todayOffset * 32 - 200; // ‰ªäÊó•„ÅÆ‰ΩçÁΩÆ„Åã„ÇâÂ∞ë„ÅóÂ∑¶„Å´„Ç™„Éï„Çª„ÉÉ„Éà
                this.$refs.ganttContainer.scrollLeft = Math.max(0, scrollLeft);
              }
            });
          } catch (error) {
            console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            this.isLoading = false;
          }
        },
        getProjectsForClient(clientId) {
          return this.data.projects.filter(p => p.clientid === clientId);
        },
        getSubtasksForMainTask(mainTaskId) {
          return this.data.subtasks.filter(s => s.maintaskid === mainTaskId).sort((a, b) => a.order - b.order);
        },
        getTasksForMainTask(mainTaskId) {
          return this.data.tasks.filter(t => t.maintaskid === mainTaskId);
        },
        getTasksForSubtask(subtaskId) {
          return this.data.tasks.filter(t => t.subtaskid === subtaskId);
        },
        getSubtaskRowHeight(subtaskId) {
          const tasks = this.getTasksForSubtask(subtaskId);
          if (tasks.length === 0) return 40; // „Çø„Çπ„ÇØ„Å™„Åó„ÅØ1Ë°åÂàÜ

          // „É¨„Éº„É≥Êï∞„ÇíË®àÁÆó
          const lanes = [];
          const sortedTasks = [...tasks].sort((a, b) => {
            return new Date(a.startdate) - new Date(b.startdate);
          });

          for (const t of sortedTasks) {
            const tStart = new Date(t.startdate);
            const tEnd = new Date(t.enddate);

            let placed = false;
            for (let i = 0; i < lanes.length; i++) {
              const lane = lanes[i];
              const lastTask = lane[lane.length - 1];
              const lastEnd = new Date(lastTask.enddate);

              if (tStart > lastEnd) {
                lane.push(t);
                placed = true;
                break;
              }
            }

            if (!placed) {
              lanes.push([t]);
            }
          }

          // „É¨„Éº„É≥Êï∞„Åå1„ÅÆÂ†¥Âêà„ÅØ1Ë°åÂàÜ„ÅÆÈ´ò„Åï„ÄÅ2‰ª•‰∏ä„ÅÆÂ†¥Âêà„ÅØÊã°Âºµ
          if (lanes.length === 1) {
            return 40; // 1Ë°åÂàÜ
          }
          return lanes.length * 36 + 40;
        },
        getMainTaskTitle(mainTaskId) {
          return this.data.maintasks.find(m => m.id === mainTaskId)?.title || '';
        },
        getSubtaskTitle(subtaskId) {
          return this.data.subtasks.find(s => s.id === subtaskId)?.title || '';
        },
        getStatusLabel(status) {
          const labels = { pending: 'Êú™ÁùÄÊâã', 'in-progress': 'ÈÄ≤Ë°å‰∏≠', completed: 'ÂÆå‰∫Ü' };
          return labels[status] || status;
        },
        toggleClient(clientId) {
          this.expandedClients[clientId] = !this.expandedClients[clientId];
        },
        isSaturday(date) {
          return date.getDay() === 6;
        },
        isSunday(date) {
          return date.getDay() === 0;
        },
        isHoliday(date) {
          // Êó•Êú¨„ÅÆÁ•ùÊó•„ÅÆÁ∞°ÊòìÂà§ÂÆöÔºà‰∏ªË¶Å„Å™Á•ùÊó•„ÅÆ„ÅøÔºâ
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          const day = date.getDate();

          const holidays = {
            '1-1': 'ÂÖÉÊó•',
            '2-11': 'Âª∫ÂõΩË®òÂøµ„ÅÆÊó•',
            '2-23': 'Â§©ÁöáË™ïÁîüÊó•',
            '3-20': 'Êò•ÂàÜ„ÅÆÊó•', // Âõ∫ÂÆöÔºàÂÆüÈöõ„ÅØÂπ¥„Å´„Çà„ÇäÂ§âÂãïÔºâ
            '3-21': 'Êò•ÂàÜ„ÅÆÊó•', // ‰ª£ÊõøÊó•
            '4-29': 'Êò≠Âíå„ÅÆÊó•',
            '5-3': 'ÊÜ≤Ê≥ïË®òÂøµÊó•',
            '5-4': '„Åø„Å©„Çä„ÅÆÊó•',
            '5-5': '„Åì„Å©„ÇÇ„ÅÆÊó•',
            '7-3': 'Êµ∑„ÅÆÊó•', // Á¨¨3ÊúàÊõúÊó•ÔºàÁ∞°ÊòìÂà§ÂÆöÔºâ
            '8-11': 'Â±±„ÅÆÊó•',
            '9-3': 'Êï¨ËÄÅ„ÅÆÊó•', // Á¨¨3ÊúàÊõúÊó•ÔºàÁ∞°ÊòìÂà§ÂÆöÔºâ
            '9-23': 'ÁßãÂàÜ„ÅÆÊó•', // Âõ∫ÂÆöÔºàÂÆüÈöõ„ÅØÂπ¥„Å´„Çà„ÇäÂ§âÂãïÔºâ
            '10-2': '„Çπ„Éù„Éº„ÉÑ„ÅÆÊó•', // Á¨¨2ÊúàÊõúÊó•ÔºàÁ∞°ÊòìÂà§ÂÆöÔºâ
            '11-3': 'ÊñáÂåñ„ÅÆÊó•',
            '11-23': 'Âã§Âä¥ÊÑüË¨ù„ÅÆÊó•',
            '12-31': 'Â§ßÊô¶Êó•' // ÊÖ£ÁøíÁöÑ„Å™‰ºëÊó•
          };

          const key = `${month}-${day}`;
          return holidays[key] !== undefined;
        },
        getDayClass(date, idx) {
          const classes = [];
          if (idx === this.todayOffset) classes.push('today');
          if (this.isSaturday(date)) classes.push('saturday');
          if (this.isSunday(date)) classes.push('sunday');
          if (this.isHoliday(date)) classes.push('holiday');
          return classes.join(' ');
        },
        getWeekStart(date) {
          const d = new Date(date);
          const day = d.getDay();
          const diff = day === 0 ? -6 : 1 - day; // ÊúàÊõúÊó•„ÇíÈÄ±„ÅÆÈñãÂßã„Å®„Åô„Çã
          d.setDate(d.getDate() + diff);
          d.setHours(0, 0, 0, 0);
          return d;
        },
        getWeekLabel(weekStart) {
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          return `${weekStart.getMonth() + 1}/${weekStart.getDate()}-${weekEnd.getMonth() + 1}/${weekEnd.getDate()}`;
        },
        isTaskStartDate(task, date) {
          if (!date) return false;
          const taskStart = new Date(task.startdate);
          return date.toDateString() === taskStart.toDateString();
        },
        taskStartIndex(task) {
          if (this.headerDates.length === 0) return 0;
          const taskStart = new Date(task.startdate);
          const startDate = this.headerDates[0];
          const diffTime = taskStart - startDate;
          return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        },
        getTaskBarStyle(task, subtaskId) {
          const start = new Date(task.startdate);
          const end = new Date(task.enddate);
          const taskStart = new Date(task.startdate);
          const startDate = this.headerDates[0] || new Date();

          let width, left;

          if (this.viewMode === 'week') {
            // ÈÄ±Âçò‰ΩçË°®Á§∫
            const weeks = Math.ceil((end - start) / (1000 * 60 * 60 * 24 * 7));
            width = Math.max(224, weeks * 224 - 16);

            const weekStart = this.getWeekStart(startDate);
            const taskWeekStart = this.getWeekStart(taskStart);
            const weeksDiff = Math.floor((taskWeekStart - weekStart) / (1000 * 60 * 60 * 24 * 7));
            left = weeksDiff * 224;
          } else {
            // Êó•Âçò‰ΩçË°®Á§∫
            const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            width = Math.max(32, days * 32 - 8);
            left = Math.floor((taskStart - startDate) / (1000 * 60 * 60 * 24)) * 32;
          }

          return {
            left: left + 'px',
            width: width + 'px',
            top: '0px'
          };
        },
        getTaskBarStyleWithOffset(task, taskIdx) {
          const baseStyle = this.getTaskBarStyle(task);
          // „Çø„Çπ„ÇØ„ÅÆ„É¨„Éº„É≥„ÇíË®àÁÆóÔºàÈáç„Å™„Å£„Å¶„ÅÑ„Å™„ÅÑ„Çø„Çπ„ÇØ„ÅØÂêå„Åò„É¨„Éº„É≥„Å´ÈÖçÁΩÆÔºâ
          const laneIndex = this.calculateTaskLane(task, this.getTasksForSubtask(task.subtaskid));
          baseStyle.top = (laneIndex * 36 + 4) + 'px';
          return baseStyle;
        },
        calculateTaskLane(task, allTasksInSubtask) {
          // „Çø„Çπ„ÇØ„ÅÆÈñãÂßãÊó•„Å®ÁµÇ‰∫ÜÊó•
          const taskStart = new Date(task.startdate);
          const taskEnd = new Date(task.enddate);

          // „É¨„Éº„É≥„Åî„Å®„Å´„Çø„Çπ„ÇØ„ÇíÈÖçÁΩÆ
          const lanes = [];

          // „Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÇíÈñãÂßãÊó•È†Ü„Å´„ÇΩ„Éº„Éà
          const sortedTasks = [...allTasksInSubtask].sort((a, b) => {
            return new Date(a.startdate) - new Date(b.startdate);
          });

          // ÂêÑ„Çø„Çπ„ÇØ„Å´ÂØæ„Åó„Å¶„É¨„Éº„É≥„ÇíÂâ≤„ÇäÂΩì„Å¶
          for (const t of sortedTasks) {
            const tStart = new Date(t.startdate);
            const tEnd = new Date(t.enddate);

            // Êó¢Â≠ò„ÅÆ„É¨„Éº„É≥„ÅßÈÖçÁΩÆÂèØËÉΩ„Å™Â†¥ÊâÄ„ÇíÊé¢„Åô
            let placed = false;
            for (let i = 0; i < lanes.length; i++) {
              const lane = lanes[i];
              // „Åì„ÅÆ„É¨„Éº„É≥„ÅÆÊúÄÂæå„ÅÆ„Çø„Çπ„ÇØ„Å®Èáç„Å™„Çâ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
              const lastTask = lane[lane.length - 1];
              const lastEnd = new Date(lastTask.enddate);

              if (tStart > lastEnd) {
                // Èáç„Å™„Çâ„Å™„ÅÑ„ÅÆ„Åß„ÄÅ„Åì„ÅÆ„É¨„Éº„É≥„Å´ÈÖçÁΩÆÂèØËÉΩ
                lane.push(t);
                if (t.id === task.id) {
                  return i;
                }
                placed = true;
                break;
              }
            }

            // Êó¢Â≠ò„ÅÆ„É¨„Éº„É≥„Å´ÈÖçÁΩÆ„Åß„Åç„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÄÅÊñ∞„Åó„ÅÑ„É¨„Éº„É≥„Çí‰ΩúÊàê
            if (!placed) {
              lanes.push([t]);
              if (t.id === task.id) {
                return lanes.length - 1;
              }
            }
          }

          return 0;
        },
        async saveTask() {
          try {
            await supabase
              .from('tasks')
              .update(this.editingTask)
              .eq('id', this.editingTask.id);
            
            const index = this.data.tasks.findIndex(t => t.id === this.editingTask.id);
            if (index !== -1) {
              this.data.tasks[index] = { ...this.editingTask };
            }
            this.selectedTaskForDetail = null;
          } catch (error) {
            console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
            alert('„Çø„Çπ„ÇØ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        async deleteTask() {
          if (confirm(`„Äå${this.editingTask.title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
            try {
              const { error } = await supabase
                .from('tasks')
                .delete()
                .eq('id', this.editingTask.id);
              
              if (error) throw error;
              
              this.data.tasks = this.data.tasks.filter(t => t.id !== this.editingTask.id);
              this.selectedTaskForDetail = null;
            } catch (error) {
              console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
              alert('„Çø„Çπ„ÇØ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
          }
        },
        openAddTaskModal(mainTaskId) {
          if (mainTaskId) {
            this.showAddTaskModalForMain = mainTaskId;
            this.newTaskForm.title = '';
            this.newTaskForm.startdate = this.today;
            this.newTaskForm.enddate = this.today;
            this.newTaskForm.priority = 'medium';
            this.newTaskForm.status = 'pending';
            this.newTaskForm.selectedMainTaskId = mainTaskId;
            this.newTaskForm.customMainTaskTitle = '';
          }
        },
        openAddTaskModalForSubtask(subtaskId) {
          const subtask = this.data.subtasks.find(s => s.id === subtaskId);
          if (subtask) {
            this.showAddTaskModalForMain = subtask.maintaskid;
            this.newTaskForm.title = '';
            const endDate = new Date(this.today);
            endDate.setDate(endDate.getDate() + 2);
            this.newTaskForm.startdate = this.today;
            this.newTaskForm.enddate = endDate.toISOString().split('T')[0];
            this.newTaskForm.priority = 'medium';
            this.newTaskForm.status = 'pending';
            this.newTaskForm.selectedMainTaskId = subtask.maintaskid;
            this.newTaskForm.selectedSubtaskId = subtaskId;
            this.newTaskForm.customMainTaskTitle = '';
          }
        },
        openAddTaskModalWithDate(subtaskId, clickedDate) {
          const subtask = this.data.subtasks.find(s => s.id === subtaskId);
          if (subtask) {
            this.showAddTaskModalForMain = subtask.maintaskid;
            this.newTaskForm.title = '';
            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÊó•‰ªò„ÇíÈñãÂßãÊó•„Å®„Åó„ÄÅ3Êó•Èñì„ÅÆ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê
            const startDate = new Date(clickedDate);
            const endDate = new Date(clickedDate);
            endDate.setDate(endDate.getDate() + 2); // 3Êó•Èñì
            this.newTaskForm.startdate = startDate.toISOString().split('T')[0];
            this.newTaskForm.enddate = endDate.toISOString().split('T')[0];
            this.newTaskForm.priority = 'medium';
            this.newTaskForm.status = 'pending';
            this.newTaskForm.selectedMainTaskId = subtask.maintaskid;
            this.newTaskForm.selectedSubtaskId = subtaskId;
            this.newTaskForm.customMainTaskTitle = '';
          }
        },
        async addTask() {
          if (!this.newTaskForm.title.trim()) {
            alert('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }

          let mainTaskId = this.newTaskForm.selectedMainTaskId;

          // „Äå„Åù„ÅÆ‰ªñ„ÄçÈÅ∏ÊäûÊôÇ„ÄÅ„Ç´„Çπ„Çø„É†Â§ßÂàÜÈ°û„Çí‰ΩúÊàê
          if (mainTaskId === 'other') {
            if (!this.newTaskForm.customMainTaskTitle.trim()) {
              alert('Â§ßÂàÜÈ°ûÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
              return;
            }
            // Êñ∞„Åó„ÅÑÂ§ßÂàÜÈ°û„Çí‰ΩúÊàê
            const maxOrder = Math.max(...this.data.maintasks.filter(m => m.projectid === this.currentProject.id).map(m => m.order), 0);
            const newMainTaskId = generateUUID(); // UUID„Çí‰ΩøÁî®
            const newMainTask = {
              id: newMainTaskId,
              projectid: this.currentProject.id,
              title: this.newTaskForm.customMainTaskTitle,
              order: maxOrder + 1
            };

            try {
              const { error } = await supabase
                .from('maintasks')
                .insert([newMainTask]);
              if (error) throw error;
              this.data.maintasks.push(newMainTask);
              mainTaskId = newMainTaskId;
            } catch (error) {
              console.error('Â§ßÂàÜÈ°û‰ΩúÊàê„Ç®„É©„Éº:', error);
              alert('Â§ßÂàÜÈ°û„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
              return;
            }
          }

          try {
            const newId = generateUUID(); // UUID„Çí‰ΩøÁî®
            const newTask = {
              id: newId,
              maintaskid: mainTaskId,
              subtaskid: this.newTaskForm.selectedSubtaskId || null,
              title: this.newTaskForm.title,
              startdate: this.newTaskForm.startdate,
              enddate: this.newTaskForm.enddate,
              status: this.newTaskForm.status,
              priority: this.newTaskForm.priority,
              notes: '',
              progress: 0
            };

            const { error } = await supabase
              .from('tasks')
              .insert([newTask]);

            if (error) throw error;

            this.data.tasks.push(newTask);
            this.showAddTaskModalForMain = null;
            this.newTaskForm = { title: '', startdate: this.today, enddate: this.today, priority: 'medium', status: 'pending', selectedMainTaskId: null, selectedSubtaskId: null, customMainTaskTitle: '' };
          } catch (error) {
            console.error('ËøΩÂä†„Ç®„É©„Éº:', error);
            alert('„Çø„Çπ„ÇØ„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        openAddMainTaskModal(projectId) {
          this.showAddMainTaskModal = projectId;
          this.newMainTaskForm.title = '';
        },
        async addMainTask() {
          if (!this.newMainTaskForm.title.trim() || !this.showAddMainTaskModal) {
            alert('Â§ßÂàÜÈ°ûÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const maxOrder = Math.max(...this.data.maintasks.filter(m => m.projectid === this.showAddMainTaskModal).map(m => m.order), 0);
            const newId = generateUUID(); // UUID„Çí‰ΩøÁî®
            const newMainTask = {
              id: newId,
              projectid: this.showAddMainTaskModal,
              title: this.newMainTaskForm.title,
              order: maxOrder + 1
            };

            const { error } = await supabase
              .from('maintasks')
              .insert([newMainTask]);

            if (error) throw error;

            this.data.maintasks.push(newMainTask);
            this.showAddMainTaskModal = null;
            this.newMainTaskForm = { title: '' };
          } catch (error) {
            console.error('ËøΩÂä†„Ç®„É©„Éº:', error);
            alert('Â§ßÂàÜÈ°û„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        openEditMainTaskModal(mainTask) {
          this.editingMainTask = { ...mainTask };
        },
        async updateMainTask() {
          if (!this.editingMainTask.title.trim()) {
            alert('Â§ßÂàÜÈ°ûÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const { error } = await supabase
              .from('maintasks')
              .update({ title: this.editingMainTask.title })
              .eq('id', this.editingMainTask.id);

            if (error) throw error;

            const index = this.data.maintasks.findIndex(m => m.id === this.editingMainTask.id);
            if (index !== -1) {
              this.data.maintasks[index].title = this.editingMainTask.title;
            }
            this.editingMainTask = null;
          } catch (error) {
            console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
            alert('Â§ßÂàÜÈ°û„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        async deleteMainTask(mainTask) {
          if (confirm(`„Äå${mainTask.title}„Äç„Å®„Åù„ÅÆ‰∏≠„ÅÆÂ∞èÂàÜÈ°û„Éª„Çø„Çπ„ÇØ„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
            try {
              // Â§ßÂàÜÈ°û„Å´Á¥ê„Å•„ÅèÂ∞èÂàÜÈ°û„ÅÆID„ÇíÂèñÂæó
              const subtaskIds = this.data.subtasks.filter(s => s.maintaskid === mainTask.id).map(s => s.id);

              // „Çø„Çπ„ÇØ„ÇíÂâäÈô§
              if (subtaskIds.length > 0) {
                await supabase.from('tasks').delete().in('subtaskid', subtaskIds);
              }
              await supabase.from('tasks').delete().eq('maintaskid', mainTask.id);

              // Â∞èÂàÜÈ°û„ÇíÂâäÈô§
              await supabase.from('subtasks').delete().eq('maintaskid', mainTask.id);

              // Â§ßÂàÜÈ°û„ÇíÂâäÈô§
              const { error } = await supabase.from('maintasks').delete().eq('id', mainTask.id);
              if (error) throw error;

              // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Åã„ÇâÂâäÈô§
              this.data.maintasks = this.data.maintasks.filter(m => m.id !== mainTask.id);
              this.data.subtasks = this.data.subtasks.filter(s => s.maintaskid !== mainTask.id);
              this.data.tasks = this.data.tasks.filter(t => t.maintaskid !== mainTask.id || subtaskIds.includes(t.subtaskid));
            } catch (error) {
              console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
              alert('Â§ßÂàÜÈ°û„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
          }
        },
        openAddSubtaskModal(mainTaskId) {
          this.showAddSubtaskModal = mainTaskId;
          this.newSubtaskForm.title = '';
        },
        async addSubtask() {
          if (!this.newSubtaskForm.title.trim() || !this.showAddSubtaskModal) {
            alert('Â∞èÂàÜÈ°ûÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const maxOrder = Math.max(...this.data.subtasks.filter(s => s.maintaskid === this.showAddSubtaskModal).map(s => s.order), 0);
            const newId = generateUUID();
            const newSubtask = {
              id: newId,
              maintaskid: this.showAddSubtaskModal,
              title: this.newSubtaskForm.title,
              order: maxOrder + 1
            };

            const { error } = await supabase
              .from('subtasks')
              .insert([newSubtask]);

            if (error) throw error;

            this.data.subtasks.push(newSubtask);
            this.showAddSubtaskModal = null;
            this.newSubtaskForm = { title: '' };
          } catch (error) {
            console.error('ËøΩÂä†„Ç®„É©„Éº:', error);
            alert('Â∞èÂàÜÈ°û„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        openEditSubtaskModal(subtask) {
          this.editingSubtask = { ...subtask };
        },
        async updateSubtask() {
          if (!this.editingSubtask.title.trim()) {
            alert('Â∞èÂàÜÈ°ûÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const { error } = await supabase
              .from('subtasks')
              .update({ title: this.editingSubtask.title })
              .eq('id', this.editingSubtask.id);

            if (error) throw error;

            const index = this.data.subtasks.findIndex(s => s.id === this.editingSubtask.id);
            if (index !== -1) {
              this.data.subtasks[index].title = this.editingSubtask.title;
            }
            this.editingSubtask = null;
          } catch (error) {
            console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
            alert('Â∞èÂàÜÈ°û„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        async deleteSubtask(subtask) {
          if (confirm(`„Äå${subtask.title}„Äç„Å®„Åù„ÅÆ‰∏≠„ÅÆ„Çø„Çπ„ÇØ„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
            try {
              // Â∞èÂàÜÈ°û„Å´Á¥ê„Å•„Åè„Çø„Çπ„ÇØ„ÇíÂâäÈô§
              await supabase.from('tasks').delete().eq('subtaskid', subtask.id);

              // Â∞èÂàÜÈ°û„ÇíÂâäÈô§
              const { error } = await supabase.from('subtasks').delete().eq('id', subtask.id);
              if (error) throw error;

              // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Åã„ÇâÂâäÈô§
              this.data.subtasks = this.data.subtasks.filter(s => s.id !== subtask.id);
              this.data.tasks = this.data.tasks.filter(t => t.subtaskid !== subtask.id);
            } catch (error) {
              console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
              alert('Â∞èÂàÜÈ°û„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
          }
        },
        openAddClientModal() {
          this.showAddClientModal = true;
          this.newClientForm.name = '';
        },
        openAddProjectModal(clientId) {
          this.showAddProjectModal = clientId;
          this.newProjectForm.name = '';
        },
        async addProject() {
          if (!this.newProjectForm.name.trim()) {
            alert('Ê°à‰ª∂Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const newId = generateUUID();
            const newProject = {
              id: newId,
              clientid: this.showAddProjectModal,
              name: this.newProjectForm.name
            };

            const { error } = await supabase
              .from('projects')
              .insert([newProject]);

            if (error) throw error;

            this.data.projects.push(newProject);
            this.selectedProject = newId;
            this.showAddProjectModal = null;
            this.newProjectForm = { name: '' };
          } catch (error) {
            console.error('ËøΩÂä†„Ç®„É©„Éº:', error);
            alert('Ê°à‰ª∂„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        async addClient() {
          if (!this.newClientForm.name.trim()) {
            alert('„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const newId = generateUUID(); // UUID„Çí‰ΩøÁî®
            const newClient = {
              id: newId,
              name: this.newClientForm.name
            };

            const { error } = await supabase
              .from('clients')
              .insert([newClient]);

            if (error) throw error;

            this.data.clients.push(newClient);
            this.expandedClients[newId] = true;
            this.showAddClientModal = false;
            this.newClientForm = { name: '' };
          } catch (error) {
            console.error('ËøΩÂä†„Ç®„É©„Éº:', error);
            alert('„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        openEditClientModal(client) {
          this.editingClient = { ...client };
        },
        async updateClient() {
          if (!this.editingClient.name.trim()) {
            alert('„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const { error } = await supabase
              .from('clients')
              .update({ name: this.editingClient.name })
              .eq('id', this.editingClient.id);

            if (error) throw error;

            const index = this.data.clients.findIndex(c => c.id === this.editingClient.id);
            if (index !== -1) {
              this.data.clients[index].name = this.editingClient.name;
            }
            this.editingClient = null;
          } catch (error) {
            console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
            alert('„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        async deleteClient(client) {
          if (confirm(`„Äå${client.name}„Äç„Å®„Åù„ÅÆ„Åô„Åπ„Å¶„ÅÆÊ°à‰ª∂„Éª„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
            try {
              // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å´Á¥ê„Å•„ÅèÊ°à‰ª∂„ÇíÂèñÂæó
              const projectIds = this.data.projects.filter(p => p.clientid === client.id).map(p => p.id);

              if (projectIds.length > 0) {
                // Ê°à‰ª∂„Å´Á¥ê„Å•„ÅèÂ§ßÂàÜÈ°û„ÇíÂèñÂæó
                const mainTaskIds = this.data.maintasks.filter(m => projectIds.includes(m.projectid)).map(m => m.id);

                if (mainTaskIds.length > 0) {
                  // Â§ßÂàÜÈ°û„Å´Á¥ê„Å•„ÅèÂ∞èÂàÜÈ°û„ÇíÂèñÂæó
                  const subtaskIds = this.data.subtasks.filter(s => mainTaskIds.includes(s.maintaskid)).map(s => s.id);

                  // „Çø„Çπ„ÇØ„ÇíÂâäÈô§
                  if (subtaskIds.length > 0) {
                    await supabase.from('tasks').delete().in('subtaskid', subtaskIds);
                  }
                  await supabase.from('tasks').delete().in('maintaskid', mainTaskIds);

                  // Â∞èÂàÜÈ°û„ÇíÂâäÈô§
                  await supabase.from('subtasks').delete().in('maintaskid', mainTaskIds);

                  // Â§ßÂàÜÈ°û„ÇíÂâäÈô§
                  await supabase.from('maintasks').delete().in('projectid', projectIds);
                }

                // Ê°à‰ª∂„ÇíÂâäÈô§
                await supabase.from('projects').delete().in('id', projectIds);
              }

              // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÇíÂâäÈô§
              const { error } = await supabase.from('clients').delete().eq('id', client.id);
              if (error) throw error;

              // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Åã„ÇâÂâäÈô§
              this.data.clients = this.data.clients.filter(c => c.id !== client.id);
              this.data.projects = this.data.projects.filter(p => p.clientid !== client.id);
              const mainTaskIds = this.data.maintasks.filter(m => projectIds.includes(m.projectid)).map(m => m.id);
              this.data.maintasks = this.data.maintasks.filter(m => !projectIds.includes(m.projectid));
              this.data.subtasks = this.data.subtasks.filter(s => !mainTaskIds.includes(s.maintaskid));
              this.data.tasks = this.data.tasks.filter(t => !mainTaskIds.includes(t.maintaskid));

              // ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÊúÄÂàù„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈÅ∏Êäû
              if (projectIds.includes(this.selectedProject)) {
                this.selectedProject = this.data.projects[0]?.id || null;
              }
            } catch (error) {
              console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
              alert('„ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
          }
        },
        openEditProjectModal(project) {
          this.editingProject = { ...project };
        },
        async updateProject() {
          if (!this.editingProject.name.trim()) {
            alert('Ê°à‰ª∂Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const { error } = await supabase
              .from('projects')
              .update({ name: this.editingProject.name, description: this.editingProject.description })
              .eq('id', this.editingProject.id);

            if (error) throw error;

            const index = this.data.projects.findIndex(p => p.id === this.editingProject.id);
            if (index !== -1) {
              this.data.projects[index].name = this.editingProject.name;
              this.data.projects[index].description = this.editingProject.description;
            }
            this.editingProject = null;
          } catch (error) {
            console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
            alert('Ê°à‰ª∂Âêç„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        // „Ç¨„É≥„Éà„ÉÅ„É£„Éº„ÉàÂÜÖ„Åß„Çø„Çπ„ÇØ„ÇíËøΩÂä†
        async onDateCellClick(date, subtaskId) {
          if (this.draggingTask || this.resizingTask) return; // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØÁÑ°Âäπ

          const startDate = date.toISOString().split('T')[0];
          // „Éá„Éï„Ç©„É´„Éà„Åß3Êó•ÂàÜ„ÅÆ„Çø„Çπ„ÇØ„Çí‰ΩúÊàê
          const endDateObj = new Date(date);
          endDateObj.setDate(endDateObj.getDate() + 2); // ÈñãÂßãÊó•„ÇíÂê´„ÇÅ„Å¶3Êó•ÂàÜ
          const endDate = endDateObj.toISOString().split('T')[0];

          try {
            const newId = generateUUID();
            const subtask = this.data.subtasks.find(s => s.id === subtaskId);
            const newTask = {
              id: newId,
              maintaskid: subtask?.maintaskid || null,
              subtaskid: subtaskId,
              title: 'Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ',
              startdate: startDate,
              enddate: endDate,
              status: 'pending',
              priority: 'medium',
              notes: '',
              progress: 0
            };

            const { error } = await supabase
              .from('tasks')
              .insert([newTask]);

            if (error) throw error;

            this.data.tasks.push(newTask);
          } catch (error) {
            console.error('„Çø„Çπ„ÇØËøΩÂä†„Ç®„É©„Éº:', error);
            alert('„Çø„Çπ„ÇØ„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        // „Çø„Çπ„ÇØ„Éê„Éº„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
        startDraggingTask(e, task) {
          e.stopPropagation();
          this.draggingTask = task;
          this.dragStartX = e.clientX;
          this.dragStartY = e.clientY;
          this.dragStartDate = new Date(task.startdate);
          this.isDragging = false;
        },
        // „Çø„Çπ„ÇØ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        handleTaskClick(task) {
          if (!this.isDragging) {
            this.selectedTaskForDetail = task;
          }
        },
        // „Çø„Çπ„ÇØ„Éê„Éº„ÅÆ„É™„Çµ„Ç§„Ç∫ÈñãÂßã
        startResizingTask(e, task) {
          e.stopPropagation();
          this.resizingTask = task;
          this.dragStartX = e.clientX;
          const start = new Date(task.startdate);
          const end = new Date(task.enddate);
          this.resizeStartWidth = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        },
        // „Éû„Ç¶„ÇπÁßªÂãïÂá¶ÁêÜ
        onMouseMove(e) {
          if (this.draggingTask) {
            const deltaX = e.clientX - this.dragStartX;
            const deltaY = e.clientY - this.dragStartY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            // 5px‰ª•‰∏äÁßªÂãï„Åó„Åü„Çâ„Éâ„É©„ÉÉ„Ç∞„Å®„Åø„Å™„Åô
            if (distance > 5) {
              this.isDragging = true;
            }

            const deltaDays = Math.round(deltaX / 32);

            const newStartDate = new Date(this.dragStartDate);
            newStartDate.setDate(newStartDate.getDate() + deltaDays);

            const taskDuration = Math.floor((new Date(this.draggingTask.enddate) - new Date(this.draggingTask.startdate)) / (1000 * 60 * 60 * 24));
            const newEndDate = new Date(newStartDate);
            newEndDate.setDate(newEndDate.getDate() + taskDuration);

            this.draggingTask.startdate = newStartDate.toISOString().split('T')[0];
            this.draggingTask.enddate = newEndDate.toISOString().split('T')[0];
          } else if (this.resizingTask) {
            const deltaX = e.clientX - this.dragStartX;
            const deltaDays = Math.round(deltaX / 32);
            const newWidth = Math.max(1, this.resizeStartWidth + deltaDays);

            const newEndDate = new Date(this.resizingTask.startdate);
            newEndDate.setDate(newEndDate.getDate() + newWidth - 1);

            this.resizingTask.enddate = newEndDate.toISOString().split('T')[0];
          }
        },
        // „Éû„Ç¶„Çπ„Éú„Çø„É≥Ëß£ÊîæÂá¶ÁêÜ
        async onMouseUp() {
          if (this.draggingTask) {
            if (this.isDragging) {
              await this.saveTaskDates(this.draggingTask);
            }
            this.draggingTask = null;
            // isDragging„Éï„É©„Ç∞„ÅØÂ∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„É™„Çª„ÉÉ„ÉàÔºà„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÅÆÂæå„Å´ÂÆüË°åÔºâ
            setTimeout(() => {
              this.isDragging = false;
            }, 10);
          } else if (this.resizingTask) {
            await this.saveTaskDates(this.resizingTask);
            this.resizingTask = null;
          }
        },
        // „Çø„Çπ„ÇØ„ÅÆÊó•‰ªò„Çí‰øùÂ≠ò
        async saveTaskDates(task) {
          try {
            await supabase
              .from('tasks')
              .update({ startdate: task.startdate, enddate: task.enddate })
              .eq('id', task.id);
          } catch (error) {
            console.error('Êó•‰ªò‰øùÂ≠ò„Ç®„É©„Éº:', error);
            alert('Êó•‰ªò„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        // Â§ßÂàÜÈ°û„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
        startDraggingMainTask(e, mainTask) {
          this.draggingMainTask = mainTask;
          e.dataTransfer.effectAllowed = 'move';
        },
        // Â§ßÂàÜÈ°û„ÅÆ„Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„Éº
        onDragOverMainTask(e, mainTask) {
          if (!this.draggingMainTask || this.draggingMainTask.id === mainTask.id) return;
          this.dragOverItem = mainTask.id;
        },
        // Â§ßÂàÜÈ°û„ÅÆ„Éâ„É≠„ÉÉ„Éó
        async onDropMainTask(e, targetMainTask) {
          if (!this.draggingMainTask || this.draggingMainTask.id === targetMainTask.id) return;

          try {
            // Âêå„Åò„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„ÅÆÂ§ßÂàÜÈ°û„ÅÆ„Åø‰∏¶„Å≥Êõø„ÅàÂèØËÉΩ
            if (this.draggingMainTask.projectid !== targetMainTask.projectid) {
              alert('Âêå„Åò„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„Åß„ÅÆ„Åø‰∏¶„Å≥Êõø„Åà„ÅåÂèØËÉΩ„Åß„Åô');
              return;
            }

            const projectMainTasks = this.currentMainTasks.slice();
            const dragIndex = projectMainTasks.findIndex(m => m.id === this.draggingMainTask.id);
            const dropIndex = projectMainTasks.findIndex(m => m.id === targetMainTask.id);

            // ÈÖçÂàóÂÜÖ„Åß‰ΩçÁΩÆ„ÇíÂÖ•„ÇåÊõø„Åà
            projectMainTasks.splice(dragIndex, 1);
            projectMainTasks.splice(dropIndex, 0, this.draggingMainTask);

            // order„ÇíÂÜçË®àÁÆó
            const updates = projectMainTasks.map((m, index) => ({
              id: m.id,
              order: index
            }));

            // „Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÊõ¥Êñ∞
            for (const update of updates) {
              await supabase
                .from('maintasks')
                .update({ order: update.order })
                .eq('id', update.id);

              // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
              const localTask = this.data.maintasks.find(m => m.id === update.id);
              if (localTask) localTask.order = update.order;
            }

            this.dragOverItem = null;
          } catch (error) {
            console.error('‰∏¶„Å≥Êõø„Åà„Ç®„É©„Éº:', error);
            alert('‰∏¶„Å≥Êõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        // Â∞èÂàÜÈ°û„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÈñãÂßã
        startDraggingSubtask(e, subtask) {
          this.draggingSubtask = subtask;
          e.dataTransfer.effectAllowed = 'move';
        },
        // Â∞èÂàÜÈ°û„ÅÆ„Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„Éº
        onDragOverSubtask(e, subtask) {
          if (!this.draggingSubtask || this.draggingSubtask.id === subtask.id) return;
          this.dragOverItem = subtask.id;
        },
        // Â∞èÂàÜÈ°û„ÅÆ„Éâ„É≠„ÉÉ„Éó
        async onDropSubtask(e, targetSubtask) {
          if (!this.draggingSubtask || this.draggingSubtask.id === targetSubtask.id) return;

          try {
            // Âêå„ÅòÂ§ßÂàÜÈ°ûÂÜÖ„ÅÆÂ∞èÂàÜÈ°û„ÅÆ„Åø‰∏¶„Å≥Êõø„ÅàÂèØËÉΩ
            if (this.draggingSubtask.maintaskid !== targetSubtask.maintaskid) {
              alert('Âêå„ÅòÂ§ßÂàÜÈ°ûÂÜÖ„Åß„ÅÆ„Åø‰∏¶„Å≥Êõø„Åà„ÅåÂèØËÉΩ„Åß„Åô');
              return;
            }

            const mainTaskSubtasks = this.getSubtasksForMainTask(targetSubtask.maintaskid);
            const dragIndex = mainTaskSubtasks.findIndex(s => s.id === this.draggingSubtask.id);
            const dropIndex = mainTaskSubtasks.findIndex(s => s.id === targetSubtask.id);

            // ÈÖçÂàóÂÜÖ„Åß‰ΩçÁΩÆ„ÇíÂÖ•„ÇåÊõø„Åà
            mainTaskSubtasks.splice(dragIndex, 1);
            mainTaskSubtasks.splice(dropIndex, 0, this.draggingSubtask);

            // order„ÇíÂÜçË®àÁÆó
            const updates = mainTaskSubtasks.map((s, index) => ({
              id: s.id,
              order: index
            }));

            // „Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÊõ¥Êñ∞
            for (const update of updates) {
              await supabase
                .from('subtasks')
                .update({ order: update.order })
                .eq('id', update.id);

              // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
              const localSubtask = this.data.subtasks.find(s => s.id === update.id);
              if (localSubtask) localSubtask.order = update.order;
            }

            this.dragOverItem = null;
          } catch (error) {
            console.error('‰∏¶„Å≥Êõø„Åà„Ç®„É©„Éº:', error);
            alert('‰∏¶„Å≥Êõø„Åà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü
        endDragging() {
          this.draggingMainTask = null;
          this.draggingSubtask = null;
          this.dragOverItem = null;
        },
        // ToDo methods
        async toggleTodoComplete(todo) {
          try {
            const newCompleted = !todo.completed;
            await supabase.from('todos').update({ completed: newCompleted }).eq('id', todo.id);
            const index = this.data.todos.findIndex(t => t.id === todo.id);
            if (index !== -1) this.data.todos[index].completed = newCompleted;
          } catch (error) {
            console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
            alert('ToDo„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        async addTodo() {
          if (!this.newTodoForm.title.trim()) {
            alert('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            const newTodo = {
              id: generateUUID(),
              projectid: this.selectedProject,
              title: this.newTodoForm.title,
              duedate: this.newTodoForm.duedate || null,
              completed: false
            };
            await supabase.from('todos').insert([newTodo]);
            this.data.todos.push(newTodo);
            this.showAddTodoModal = false;
            this.newTodoForm = { title: '', duedate: '', projectid: null };
          } catch (error) {
            console.error('ËøΩÂä†„Ç®„É©„Éº:', error);
            alert('ToDo„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        async updateTodo() {
          if (!this.editingTodo.title.trim()) {
            alert('„Çø„Çπ„ÇØÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
          }
          try {
            await supabase.from('todos').update({
              title: this.editingTodo.title,
              duedate: this.editingTodo.duedate
            }).eq('id', this.editingTodo.id);
            const index = this.data.todos.findIndex(t => t.id === this.editingTodo.id);
            if (index !== -1) {
              this.data.todos[index].title = this.editingTodo.title;
              this.data.todos[index].duedate = this.editingTodo.duedate;
            }
            this.editingTodo = null;
          } catch (error) {
            console.error('Êõ¥Êñ∞„Ç®„É©„Éº:', error);
            alert('ToDo„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          }
        },
        async deleteTodo(todo) {
          if (confirm(`„Äå${todo.title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
            try {
              await supabase.from('todos').delete().eq('id', todo.id);
              this.data.todos = this.data.todos.filter(t => t.id !== todo.id);
            } catch (error) {
              console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
              alert('ToDo„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
          }
        }
      },
      watch: {
        selectedTaskForDetail(newVal) {
          if (newVal) {
            this.editingTask = { ...newVal };
          }
        }
      },
      mounted() {
        this.loadData();
        // „Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
        document.addEventListener('mousemove', this.onMouseMove);
        document.addEventListener('mouseup', this.onMouseUp);

        // „Ç¨„É≥„Éà„ÉÅ„É£„Éº„Éà„Çí‰ªäÊó•„ÅÆÊó•‰ªò„Å´„Çπ„ÇØ„É≠„Éº„É´
        this.$nextTick(() => {
          if (this.$refs.ganttContainer) {
            const todayPosition = this.todayOffset * 32; // 32px„ÅØ1Êó•ÂàÜ„ÅÆÂπÖ
            const containerWidth = this.$refs.ganttContainer.clientWidth;
            const scrollPosition = todayPosition - containerWidth / 2 + 16; // ÁîªÈù¢‰∏≠Â§Æ„Å´Ë°®Á§∫
            this.$refs.ganttContainer.scrollLeft = Math.max(0, scrollPosition);
          }
        });
      },
      beforeUnmount() {
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
        document.removeEventListener('mousemove', this.onMouseMove);
        document.removeEventListener('mouseup', this.onMouseUp);
      }
    }).mount('#app');
  </script>
</body>
</html>
