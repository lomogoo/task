<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>業務管理ダッシュボード - Rick's</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      border-bottom: 1px solid #e2e8f0;
      background-color: white;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    header p {
      font-size: 14px;
      color: #64748b;
    }

    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 256px;
      border-right: 1px solid #e2e8f0;
      background-color: #f1f5f9;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .sidebar-title {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      font-size: 14px;
      color: #475569;
    }

    .sidebar-title button:hover {
      background-color: #e2e8f0;
    }

    .client-item {
      margin-bottom: 8px;
    }

    .client-header-container {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .client-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      cursor: pointer;
      background: none;
      border: none;
      flex: 1;
      transition: background-color 0.2s;
    }

    .client-header:hover {
      background-color: #e2e8f0;
    }

    .client-header .chevron {
      transition: transform 0.2s;
      width: 16px;
      height: 16px;
    }

    .client-header.collapsed .chevron {
      transform: rotate(-90deg);
    }

    .client-count {
      font-size: 12px;
      color: #64748b;
      margin-left: auto;
    }

    .client-edit-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      color: #475569;
      font-size: 12px;
    }

    .client-item:hover .client-edit-btn {
      opacity: 1;
    }

    .client-edit-btn:hover {
      background-color: #cbd5e1;
    }

    .projects-list {
      margin-left: 8px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .project-btn-container {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .project-btn {
      text-align: left;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      background: none;
      color: #475569;
      display: flex;
      align-items: center;
      justify-content: space-between;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .project-btn:hover {
      background-color: #e2e8f0;
    }

    .project-btn.active {
      background-color: #3b82f6;
      color: white;
      font-weight: 600;
    }

    .project-btn .project-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .project-edit-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      color: #475569;
      font-size: 12px;
    }

    .project-btn-container:hover .project-edit-btn {
      opacity: 1;
    }

    .project-edit-btn:hover {
      background-color: #cbd5e1;
    }

    .project-add-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      color: #475569;
      font-size: 14px;
    }

    .project-btn-container:hover .project-add-btn {
      opacity: 1;
    }

    .project-add-btn:hover {
      background-color: #cbd5e1;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .controls-bar {
      border-bottom: 1px solid #e2e8f0;
      background-color: white;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .view-toggle {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .view-toggle label {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
    }

    .view-btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background-color: white;
      color: #475569;
      transition: all 0.2s;
    }

    .view-btn:hover {
      background-color: #f1f5f9;
    }

    .view-btn.active {
      background-color: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }

    .today-display {
      font-size: 14px;
      color: #64748b;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 16px;
      color: #64748b;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e2e8f0;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .gantt-section {
      padding: 24px;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .gantt-section-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
    }

    .gantt-title-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .gantt-title {
      font-size: 14px;
      font-weight: 700;
      color: #0f172a;
    }

    .gantt-title-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
      color: #475569;
      font-weight: 600;
    }

    .gantt-title-btn:hover {
      background-color: #e2e8f0;
    }

    .gantt-container {
      flex: 1;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background-color: white;
      position: relative;
    }

    .gantt-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f1f5f9;
      border-bottom: 1px solid #e2e8f0;
    }

    .gantt-header-row {
      display: flex;
    }

    .gantt-header-cell {
      width: 192px;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #64748b;
      border-right: 1px solid #e2e8f0;
      flex-shrink: 0;
    }

    .gantt-dates-header {
      display: flex;
      flex-shrink: 0;
      flex: 1;
    }

    .gantt-month-row {
      display: flex;
      border-bottom: 1px solid #e2e8f0;
    }

    .gantt-month-header {
      text-align: center;
      border-right: 1px solid #e2e8f0;
      font-size: 12px;
      color: #64748b;
      padding: 6px 4px;
      font-weight: 600;
      background-color: #f8fafc;
    }

    .gantt-day-row {
      display: flex;
    }

    .gantt-date-header {
      width: 32px;
      text-align: center;
      border-right: 1px solid #e2e8f0;
      font-size: 12px;
      color: #64748b;
      padding: 8px 4px;
      flex-shrink: 0;
    }

    .gantt-date-header.today {
      background-color: #dbeafe;
      color: #1e40af;
      font-weight: 700;
    }

    .gantt-body {
      display: flex;
      flex-direction: column;
    }

    .gantt-row {
      display: flex;
      border-bottom: 1px solid #f1f5f9;
      min-height: 40px;
    }

    .gantt-row:hover {
      background-color: #f8fafc;
    }

    .gantt-cell {
      width: 192px;
      padding: 12px;
      border-right: 1px solid #e2e8f0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-shrink: 0;
      display: flex;
      align-items: center;
    }

    .gantt-cell.main-task {
      background-color: #f1f5f9;
      font-weight: 600;
      color: #0f172a;
    }

    .gantt-cell.sub-task {
      padding-left: 32px;
      color: #475569;
      font-size: 14px;
    }

    .gantt-dates-row {
      display: flex;
      position: relative;
      flex: 1;
      flex-shrink: 0;
    }

    .gantt-date-cell {
      width: 32px;
      border-right: 1px solid #e2e8f0;
      position: relative;
      flex-shrink: 0;
      cursor: pointer;
    }

    .gantt-date-cell:hover {
      background-color: #f0f9ff;
    }

    .gantt-date-cell.today {
      background-color: #f0f9ff;
    }

    .gantt-bars-container {
      position: absolute;
      top: 4px;
      left: 0;
      right: 0;
      height: 32px;
      pointer-events: none;
    }

    .gantt-bar {
      position: absolute;
      height: 28px;
      border-radius: 4px;
      cursor: move;
      display: flex;
      align-items: center;
      padding: 0 8px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: opacity 0.2s;
      pointer-events: auto;
      top: 0;
      border: 2px solid transparent;
      user-select: none;
    }

    .gantt-bar:hover {
      opacity: 0.9;
      border-color: rgba(255, 255, 255, 0.5);
    }

    .gantt-bar-resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 8px;
      cursor: ew-resize;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 0 4px 4px 0;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .gantt-bar:hover .gantt-bar-resize-handle {
      opacity: 1;
    }

    .gantt-bar.completed {
      background-color: #10b981;
    }

    .gantt-bar.in-progress {
      background-color: #3b82f6;
    }

    .gantt-bar.pending {
      background-color: #94a3b8;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }

    .badge.pending {
      background-color: #f1f5f9;
      color: #475569;
    }

    .badge.in-progress {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .badge.completed {
      background-color: #dcfce7;
      color: #166534;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background-color: #e2e8f0;
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: #3b82f6;
      transition: width 0.2s;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      border-bottom: 1px solid #e2e8f0;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 700;
      color: #0f172a;
      position: sticky;
      top: 0;
      background-color: white;
    }

    .modal-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      transition: color 0.2s;
      font-size: 18px;
    }

    .modal-close:hover {
      color: #0f172a;
    }

    .modal-content {
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .progress-control {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .progress-input {
      width: 100%;
    }

    .progress-track {
      width: 100%;
      height: 6px;
      background-color: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-track-fill {
      height: 100%;
      background-color: #3b82f6;
      transition: width 0.2s;
    }

    .readonly-field {
      background-color: #f1f5f9;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      color: #475569;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .btn {
      flex: 1;
      padding: 10px 16px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2563eb;
    }

    .btn-secondary {
      background-color: #e2e8f0;
      color: #475569;
    }

    .btn-secondary:hover {
      background-color: #cbd5e1;
    }

    .btn-danger {
      background-color: #fecaca;
      color: #991b1b;
    }

    .btn-danger:hover {
      background-color: #fca5a5;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      flex: none;
      width: auto;
    }

    .empty-message {
      text-align: center;
      color: #94a3b8;
      padding: 24px;
      font-size: 14px;
    }

    .main-task-select-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .main-task-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .main-task-btn {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      background-color: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .main-task-btn:hover {
      border-color: #3b82f6;
      background-color: #f0f9ff;
    }

    .main-task-btn.selected {
      background-color: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .other-input {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }
  </style>
</head>
<body>
  <div id="app">
    <div v-if="isLoading" class="loading">
      <div class="spinner"></div>
      データを読み込み中...
    </div>

    <template v-else>
      <header>
        <h1>業務管理ダッシュボード</h1>
        <p v-if="currentClient && currentProject">
          {{ currentClient.name }} / {{ currentProject.name }}
        </p>
      </header>

      <div class="main-container">
        <div class="sidebar">
          <div class="sidebar-title">
            <span>案件一覧</span>
            <button @click="openAddClientModal" title="クライアントを追加">+</button>
          </div>
          
          <div style="flex: 1; overflow-y: auto;">
            <div v-for="client in data.clients" :key="client.id" class="client-item">
              <div class="client-header-container">
                <button 
                  @click="toggleClient(client.id)"
                  class="client-header" 
                  :class="{ collapsed: !expandedClients[client.id] }"
                >
                  <span class="chevron">▼</span>
                  <span>{{ client.name }}</span>
                  <span class="client-count">({{ getProjectsForClient(client.id).length }})</span>
                </button>
                <button 
                  @click="openEditClientModal(client)"
                  class="client-edit-btn"
                  title="クライアント名を編集"
                >✏️</button>
              </div>

              <div v-if="expandedClients[client.id]" class="projects-list">
                <div v-for="project in getProjectsForClient(client.id)" :key="project.id" class="project-btn-container">
                  <button
                    @click="selectedProject = project.id"
                    class="project-btn"
                    :class="{ active: selectedProject === project.id }"
                  >
                    <span class="project-name">{{ project.name }}</span>
                  </button>
                  <button 
                    @click="openEditProjectModal(project)"
                    class="project-edit-btn"
                    title="案件名を編集"
                  >✏️</button>
                  <button 
                    @click="openAddMainTaskModal(project.id)"
                    class="project-add-btn"
                    title="大分類を追加"
                  >+</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="content">
          <div class="controls-bar">
            <div class="view-toggle">
              <label>表示モード:</label>
              <button 
                @click="viewMode = 'day'" 
                class="view-btn" 
                :class="{ active: viewMode === 'day' }"
              >
                日単位
              </button>
            </div>
            <div class="today-display">本日: {{ today }}</div>
          </div>

          <div class="gantt-section">
            <div class="gantt-section-inner">
              <div class="gantt-title-row">
                <h2 class="gantt-title">ガントチャート</h2>
                <button @click="openAddTaskModal(currentMainTasks[0]?.id)" class="gantt-title-btn" title="タスクを追加">+ タスク追加</button>
              </div>
              <div class="gantt-container" ref="ganttContainer">
                <div class="gantt-header">
                  <!-- 月表示行 -->
                  <div class="gantt-header-row gantt-month-row">
                    <div class="gantt-header-cell">タスク</div>
                    <div class="gantt-dates-header">
                      <div
                        v-for="(group, idx) in monthGroups"
                        :key="idx"
                        class="gantt-month-header"
                        :style="{ width: (group.count * 32) + 'px' }"
                      >
                        {{ group.label }}
                      </div>
                    </div>
                  </div>
                  <!-- 日表示行 -->
                  <div class="gantt-header-row gantt-day-row">
                    <div class="gantt-header-cell" style="border-top: 1px solid #e2e8f0;"></div>
                    <div class="gantt-dates-header">
                      <div
                        v-for="(date, idx) in headerDates"
                        :key="idx"
                        class="gantt-date-header"
                        :class="{ today: idx === todayOffset }"
                      >
                        {{ date.getDate() }}
                      </div>
                    </div>
                  </div>
                </div>

                <div class="gantt-body">
                  <template v-for="mainTask in currentMainTasks" :key="mainTask.id">
                    <!-- 大分類の行（タイトルのみ、タスクバーなし） -->
                    <div class="gantt-row">
                      <div class="gantt-cell main-task">{{ mainTask.title }}</div>
                      <div class="gantt-dates-row">
                        <div
                          v-for="(date, idx) in headerDates"
                          :key="idx"
                          class="gantt-date-cell"
                          :class="{ today: idx === todayOffset }"
                          @click="onDateCellClick(date, mainTask.id)"
                        ></div>
                      </div>
                    </div>

                    <!-- 小分類の行（各taskを1行ずつ表示） -->
                    <template v-for="task in getTasksForMainTask(mainTask.id)" :key="task.id">
                      <div class="gantt-row">
                        <div class="gantt-cell sub-task">{{ task.title }}</div>
                        <div class="gantt-dates-row">
                          <div
                            v-for="(date, idx) in headerDates"
                            :key="idx"
                            class="gantt-date-cell"
                            :class="{ today: idx === todayOffset }"
                          ></div>
                          <!-- 小分類に対応するタスクバーを表示 -->
                          <div class="gantt-bars-container">
                            <div
                              v-if="isTaskStartDate(task, headerDates[taskStartIndex(task)])"
                              class="gantt-bar"
                              :class="task.status"
                              :style="getTaskBarStyle(task)"
                              :title="task.title"
                              @mousedown="startDraggingTask($event, task)"
                              @dblclick="selectedTaskForDetail = task"
                            >
                              {{ task.title }}
                              <div
                                class="gantt-bar-resize-handle"
                                @mousedown.stop="startResizingTask($event, task)"
                              ></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                  </template>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Task Detail Modal -->
      <div v-if="selectedTaskForDetail" class="modal-overlay" @click="selectedTaskForDetail = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>タスク詳細</span>
            <button @click="selectedTaskForDetail = null" class="modal-close">✕</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>タスク名</label>
              <input v-model="editingTask.title" type="text">
            </div>

            <div class="form-group">
              <label>大分類</label>
              <div class="readonly-field">{{ getMainTaskTitle(editingTask.maintaskid) }}</div>
            </div>

            <div class="form-group">
              <label>ステータス</label>
              <select v-model="editingTask.status">
                <option value="pending">未着手</option>
                <option value="in-progress">進行中</option>
                <option value="completed">完了</option>
              </select>
            </div>

            <div class="form-group">
              <label>優先度</label>
              <select v-model="editingTask.priority">
                <option value="low">低</option>
                <option value="medium">中</option>
                <option value="high">高</option>
              </select>
            </div>

            <div class="form-group progress-control">
              <label>進捗: {{ editingTask.progress }}%</label>
              <input v-model.number="editingTask.progress" type="range" min="0" max="100" class="progress-input">
              <div class="progress-track">
                <div class="progress-track-fill" :style="{ width: editingTask.progress + '%' }"></div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>開始日</label>
                <input v-model="editingTask.startdate" type="date">
              </div>
              <div class="form-group">
                <label>終了日</label>
                <input v-model="editingTask.enddate" type="date">
              </div>
            </div>

            <div class="form-group">
              <label>メモ</label>
              <textarea v-model="editingTask.notes" placeholder="メモを入力..."></textarea>
            </div>

            <div class="modal-actions">
              <button @click="saveTask" class="btn btn-primary">保存</button>
              <button @click="deleteTask" class="btn btn-danger btn-small">削除</button>
              <button @click="selectedTaskForDetail = null" class="btn btn-secondary">キャンセル</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Task Modal -->
      <div v-if="showAddTaskModalForMain" class="modal-overlay" @click="showAddTaskModalForMain = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>新しいタスクを追加</span>
            <button @click="showAddTaskModalForMain = null" class="modal-close">✕</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>大分類を選択</label>
              <div class="main-task-select-group">
                <div class="main-task-buttons">
                  <button
                    v-for="mainTask in currentMainTasks"
                    :key="mainTask.id"
                    @click="newTaskForm.selectedMainTaskId = mainTask.id; newTaskForm.customMainTaskTitle = '';"
                    class="main-task-btn"
                    :class="{ selected: newTaskForm.selectedMainTaskId === mainTask.id }"
                  >
                    {{ mainTask.title }}
                  </button>
                  <button
                    @click="newTaskForm.selectedMainTaskId = 'other'"
                    class="main-task-btn"
                    :class="{ selected: newTaskForm.selectedMainTaskId === 'other' }"
                  >
                    その他
                  </button>
                </div>
                <div v-if="newTaskForm.selectedMainTaskId === 'other'" class="other-input">
                  <label>大分類名を入力</label>
                  <input v-model="newTaskForm.customMainTaskTitle" type="text" placeholder="新しい大分類名を入力">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>タスク名 *</label>
              <input v-model="newTaskForm.title" type="text" placeholder="タスク名を入力" @keyup.enter="addTask">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>開始日</label>
                <input v-model="newTaskForm.startdate" type="date">
              </div>
              <div class="form-group">
                <label>終了日</label>
                <input v-model="newTaskForm.enddate" type="date">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>優先度</label>
                <select v-model="newTaskForm.priority">
                  <option value="low">低</option>
                  <option value="medium">中</option>
                  <option value="high">高</option>
                </select>
              </div>
              <div class="form-group">
                <label>ステータス</label>
                <select v-model="newTaskForm.status">
                  <option value="pending">未着手</option>
                  <option value="in-progress">進行中</option>
                  <option value="completed">完了</option>
                </select>
              </div>
            </div>

            <div class="modal-actions">
              <button @click="addTask" class="btn btn-primary">追加</button>
              <button @click="showAddTaskModalForMain = null" class="btn btn-secondary">キャンセル</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Main Task Modal -->
      <div v-if="showAddMainTaskModal" class="modal-overlay" @click="showAddMainTaskModal = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>大分類を追加</span>
            <button @click="showAddMainTaskModal = null" class="modal-close">✕</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>大分類名 *</label>
              <input v-model="newMainTaskForm.title" type="text" placeholder="大分類名を入力（自由に入力可能）" @keyup.enter="addMainTask">
            </div>

            <div class="modal-actions">
              <button @click="addMainTask" class="btn btn-primary">追加</button>
              <button @click="showAddMainTaskModal = null" class="btn btn-secondary">キャンセル</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Client Modal -->
      <div v-if="showAddClientModal" class="modal-overlay" @click="showAddClientModal = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>クライアントを追加</span>
            <button @click="showAddClientModal = null" class="modal-close">✕</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>クライアント名 *</label>
              <input v-model="newClientForm.name" type="text" placeholder="クライアント名を入力" @keyup.enter="addClient">
            </div>

            <div class="modal-actions">
              <button @click="addClient" class="btn btn-primary">追加</button>
              <button @click="showAddClientModal = null" class="btn btn-secondary">キャンセル</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Client Modal -->
      <div v-if="editingClient" class="modal-overlay" @click="editingClient = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>クライアント名を編集</span>
            <button @click="editingClient = null" class="modal-close">✕</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>クライアント名</label>
              <input v-model="editingClient.name" type="text" @keyup.enter="updateClient">
            </div>

            <div class="modal-actions">
              <button @click="updateClient" class="btn btn-primary">保存</button>
              <button @click="editingClient = null" class="btn btn-secondary">キャンセル</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Project Modal -->
      <div v-if="editingProject" class="modal-overlay" @click="editingProject = null">
        <div class="modal" @click.stop>
          <div class="modal-header">
            <span>案件名を編集</span>
            <button @click="editingProject = null" class="modal-close">✕</button>
          </div>

          <div class="modal-content">
            <div class="form-group">
              <label>案件名</label>
              <input v-model="editingProject.name" type="text" @keyup.enter="updateProject">
            </div>
            <div class="form-group">
              <label>説明</label>
              <textarea v-model="editingProject.description" placeholder="説明を入力..."></textarea>
            </div>

            <div class="modal-actions">
              <button @click="updateProject" class="btn btn-primary">保存</button>
              <button @click="editingProject = null" class="btn btn-secondary">キャンセル</button>
            </div>
          </div>
        </div>
      </div>
    </template>
  </div>

  <script>
    const { createApp } = Vue;
    const { createClient } = window.supabase;

    const SUPABASE_URL = 'https://dsuiaaaxwwvhiqktgvoi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzdWlhYWF4d3d2aGlxa3Rndm9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxODcxODQsImV4cCI6MjA3ODc2MzE4NH0.ng7SlvSE25Ef_EZZeTe5F2tGcHNco1x1iZ_Nx4ewohg';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // UUID生成関数
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    createApp({
      data() {
        return {
          data: {
            clients: [],
            projects: [],
            maintasks: [],
            tasks: []
          },
          isLoading: true,
          selectedProject: 'p1',
          selectedTaskForDetail: null,
          editingTask: {},
          editingClient: null,
          editingProject: null,
          viewMode: 'day',
          expandedClients: {},
          showAddTaskModalForMain: null,
          showAddMainTaskModal: null,
          showAddClientModal: false,
          newTaskForm: {
            title: '',
            startdate: '',
            enddate: '',
            priority: 'medium',
            status: 'pending',
            selectedMainTaskId: null,
            customMainTaskTitle: ''
          },
          newMainTaskForm: {
            title: ''
          },
          newClientForm: {
            name: ''
          },
          draggingTask: null,
          resizingTask: null,
          dragStartX: 0,
          dragStartDate: null,
          resizeStartWidth: 0
        };
      },
      computed: {
        today() {
          const d = new Date();
          return d.toISOString().split('T')[0];
        },
        currentClient() {
          const project = this.data.projects.find(p => p.id === this.selectedProject);
          return project ? this.data.clients.find(c => c.id === project.clientid) : null;
        },
        currentProject() {
          return this.data.projects.find(p => p.id === this.selectedProject);
        },
        currentMainTasks() {
          return this.data.maintasks
            .filter(m => m.projectid === this.selectedProject)
            .sort((a, b) => a.order - b.order);
        },
        projectTasks() {
          const mainTaskIds = this.currentMainTasks.map(m => m.id);
          return this.data.tasks.filter(t => mainTaskIds.includes(t.maintaskid));
        },
        headerDates() {
          const dates = [];
          const startDate = new Date(this.today);
          startDate.setDate(startDate.getDate() - 30); // 過去30日から開始
          for (let i = 0; i < 365; i++) { // 365日間表示
            const date = new Date(startDate);
            date.setDate(date.getDate() + i);
            dates.push(date);
          }
          return dates;
        },
        todayOffset() {
          const startDate = new Date(this.today);
          startDate.setDate(startDate.getDate() - 30); // 過去30日から開始
          const diffTime = new Date(this.today) - startDate;
          return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        },
        monthGroups() {
          const groups = [];
          let currentMonth = null;
          let currentGroup = null;

          this.headerDates.forEach((date, idx) => {
            const monthYear = `${date.getFullYear()}年${date.getMonth() + 1}月`;
            if (monthYear !== currentMonth) {
              if (currentGroup) {
                groups.push(currentGroup);
              }
              currentMonth = monthYear;
              currentGroup = { label: monthYear, count: 1 };
            } else {
              currentGroup.count++;
            }
          });

          if (currentGroup) {
            groups.push(currentGroup);
          }

          return groups;
        }
      },
      methods: {
        async loadData() {
          try {
            const [clientsRes, projectsRes, maintasksRes, tasksRes] = await Promise.all([
              supabase.from('clients').select('*'),
              supabase.from('projects').select('*'),
              supabase.from('maintasks').select('*'),
              supabase.from('tasks').select('*')
            ]);

            this.data.clients = clientsRes.data || [];
            this.data.projects = projectsRes.data || [];
            this.data.maintasks = maintasksRes.data || [];
            this.data.tasks = tasksRes.data || [];

            this.expandedClients[this.data.clients[0]?.id] = true;
            this.newTaskForm.startdate = this.today;
            this.newTaskForm.enddate = this.today;
            this.isLoading = false;

            // データロード後にガントチャートを今日の日付にスクロール
            this.$nextTick(() => {
              if (this.$refs.ganttContainer) {
                const scrollLeft = this.todayOffset * 32 - 200; // 今日の位置から少し左にオフセット
                this.$refs.ganttContainer.scrollLeft = Math.max(0, scrollLeft);
              }
            });
          } catch (error) {
            console.error('データ読み込みエラー:', error);
            this.isLoading = false;
          }
        },
        getProjectsForClient(clientId) {
          return this.data.projects.filter(p => p.clientid === clientId);
        },
        getTasksForMainTask(mainTaskId) {
          return this.data.tasks.filter(t => t.maintaskid === mainTaskId);
        },
        getMainTaskTitle(mainTaskId) {
          return this.data.maintasks.find(m => m.id === mainTaskId)?.title || '';
        },
        getStatusLabel(status) {
          const labels = { pending: '未着手', 'in-progress': '進行中', completed: '完了' };
          return labels[status] || status;
        },
        toggleClient(clientId) {
          this.expandedClients[clientId] = !this.expandedClients[clientId];
        },
        isTaskStartDate(task, date) {
          if (!date) return false;
          const taskStart = new Date(task.startdate);
          return date.toDateString() === taskStart.toDateString();
        },
        taskStartIndex(task) {
          const taskStart = new Date(task.startdate);
          const startDate = new Date(this.today);
          startDate.setDate(startDate.getDate() - 30); // 過去30日から開始
          const diffTime = taskStart - startDate;
          return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        },
        getTaskBarStyle(task) {
          const start = new Date(task.startdate);
          const end = new Date(task.enddate);
          const days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
          const width = Math.max(32, days * 32 - 8);
          const taskStart = new Date(task.startdate);
          const startDate = new Date(this.today);
          startDate.setDate(startDate.getDate() - 30); // 過去30日から開始
          const left = Math.floor((taskStart - startDate) / (1000 * 60 * 60 * 24)) * 32;

          return {
            left: left + 'px',
            width: width + 'px',
            top: '0px'
          };
        },
        async saveTask() {
          try {
            await supabase
              .from('tasks')
              .update(this.editingTask)
              .eq('id', this.editingTask.id);
            
            const index = this.data.tasks.findIndex(t => t.id === this.editingTask.id);
            if (index !== -1) {
              this.data.tasks[index] = { ...this.editingTask };
            }
            this.selectedTaskForDetail = null;
          } catch (error) {
            console.error('保存エラー:', error);
            alert('タスクの保存に失敗しました');
          }
        },
        async deleteTask() {
          if (confirm(`「${this.editingTask.title}」を削除しますか？`)) {
            try {
              const { error } = await supabase
                .from('tasks')
                .delete()
                .eq('id', this.editingTask.id);
              
              if (error) throw error;
              
              this.data.tasks = this.data.tasks.filter(t => t.id !== this.editingTask.id);
              this.selectedTaskForDetail = null;
            } catch (error) {
              console.error('削除エラー:', error);
              alert('タスクの削除に失敗しました');
            }
          }
        },
        openAddTaskModal(mainTaskId) {
          if (mainTaskId) {
            this.showAddTaskModalForMain = mainTaskId;
            this.newTaskForm.title = '';
            this.newTaskForm.startdate = this.today;
            this.newTaskForm.enddate = this.today;
            this.newTaskForm.priority = 'medium';
            this.newTaskForm.status = 'pending';
            this.newTaskForm.selectedMainTaskId = mainTaskId;
            this.newTaskForm.customMainTaskTitle = '';
          }
        },
        async addTask() {
          if (!this.newTaskForm.title.trim()) {
            alert('タスク名を入力してください');
            return;
          }

          let mainTaskId = this.newTaskForm.selectedMainTaskId;

          // 「その他」選択時、カスタム大分類を作成
          if (mainTaskId === 'other') {
            if (!this.newTaskForm.customMainTaskTitle.trim()) {
              alert('大分類名を入力してください');
              return;
            }
            // 新しい大分類を作成
            const maxOrder = Math.max(...this.data.maintasks.filter(m => m.projectid === this.currentProject.id).map(m => m.order), 0);
            const newMainTaskId = generateUUID(); // UUIDを使用
            const newMainTask = {
              id: newMainTaskId,
              projectid: this.currentProject.id,
              title: this.newTaskForm.customMainTaskTitle,
              order: maxOrder + 1
            };

            try {
              const { error } = await supabase
                .from('maintasks')
                .insert([newMainTask]);
              if (error) throw error;
              this.data.maintasks.push(newMainTask);
              mainTaskId = newMainTaskId;
            } catch (error) {
              console.error('大分類作成エラー:', error);
              alert('大分類の作成に失敗しました');
              return;
            }
          }

          try {
            const newId = generateUUID(); // UUIDを使用
            const newTask = {
              id: newId,
              maintaskid: mainTaskId,
              title: this.newTaskForm.title,
              startdate: this.newTaskForm.startdate,
              enddate: this.newTaskForm.enddate,
              status: this.newTaskForm.status,
              priority: this.newTaskForm.priority,
              notes: '',
              progress: 0
            };

            const { error } = await supabase
              .from('tasks')
              .insert([newTask]);

            if (error) throw error;

            this.data.tasks.push(newTask);
            this.showAddTaskModalForMain = null;
            this.newTaskForm = { title: '', startdate: this.today, enddate: this.today, priority: 'medium', status: 'pending', selectedMainTaskId: null, customMainTaskTitle: '' };
          } catch (error) {
            console.error('追加エラー:', error);
            alert('タスクの追加に失敗しました');
          }
        },
        openAddMainTaskModal(projectId) {
          this.showAddMainTaskModal = projectId;
          this.newMainTaskForm.title = '';
        },
        async addMainTask() {
          if (!this.newMainTaskForm.title.trim() || !this.showAddMainTaskModal) {
            alert('大分類名を入力してください');
            return;
          }
          try {
            const maxOrder = Math.max(...this.data.maintasks.filter(m => m.projectid === this.showAddMainTaskModal).map(m => m.order), 0);
            const newId = generateUUID(); // UUIDを使用
            const newMainTask = {
              id: newId,
              projectid: this.showAddMainTaskModal,
              title: this.newMainTaskForm.title,
              order: maxOrder + 1
            };

            const { error } = await supabase
              .from('maintasks')
              .insert([newMainTask]);

            if (error) throw error;

            this.data.maintasks.push(newMainTask);
            this.showAddMainTaskModal = null;
            this.newMainTaskForm = { title: '' };
          } catch (error) {
            console.error('追加エラー:', error);
            alert('大分類の追加に失敗しました');
          }
        },
        openAddClientModal() {
          this.showAddClientModal = true;
          this.newClientForm.name = '';
        },
        async addClient() {
          if (!this.newClientForm.name.trim()) {
            alert('クライアント名を入力してください');
            return;
          }
          try {
            const newId = generateUUID(); // UUIDを使用
            const newClient = {
              id: newId,
              name: this.newClientForm.name
            };

            const { error } = await supabase
              .from('clients')
              .insert([newClient]);

            if (error) throw error;

            this.data.clients.push(newClient);
            this.expandedClients[newId] = true;
            this.showAddClientModal = false;
            this.newClientForm = { name: '' };
          } catch (error) {
            console.error('追加エラー:', error);
            alert('クライアントの追加に失敗しました');
          }
        },
        openEditClientModal(client) {
          this.editingClient = { ...client };
        },
        async updateClient() {
          if (!this.editingClient.name.trim()) {
            alert('クライアント名を入力してください');
            return;
          }
          try {
            const { error } = await supabase
              .from('clients')
              .update({ name: this.editingClient.name })
              .eq('id', this.editingClient.id);

            if (error) throw error;

            const index = this.data.clients.findIndex(c => c.id === this.editingClient.id);
            if (index !== -1) {
              this.data.clients[index].name = this.editingClient.name;
            }
            this.editingClient = null;
          } catch (error) {
            console.error('更新エラー:', error);
            alert('クライアント名の更新に失敗しました');
          }
        },
        openEditProjectModal(project) {
          this.editingProject = { ...project };
        },
        async updateProject() {
          if (!this.editingProject.name.trim()) {
            alert('案件名を入力してください');
            return;
          }
          try {
            const { error } = await supabase
              .from('projects')
              .update({ name: this.editingProject.name, description: this.editingProject.description })
              .eq('id', this.editingProject.id);

            if (error) throw error;

            const index = this.data.projects.findIndex(p => p.id === this.editingProject.id);
            if (index !== -1) {
              this.data.projects[index].name = this.editingProject.name;
              this.data.projects[index].description = this.editingProject.description;
            }
            this.editingProject = null;
          } catch (error) {
            console.error('更新エラー:', error);
            alert('案件名の更新に失敗しました');
          }
        },
        // ガントチャート内でタスクを追加
        async onDateCellClick(date, mainTaskId) {
          if (this.draggingTask || this.resizingTask) return; // ドラッグ中は無効

          const startDate = date.toISOString().split('T')[0];
          // デフォルトで3日分のタスクを作成
          const endDateObj = new Date(date);
          endDateObj.setDate(endDateObj.getDate() + 2); // 開始日を含めて3日分
          const endDate = endDateObj.toISOString().split('T')[0];

          try {
            const newId = generateUUID();
            const newTask = {
              id: newId,
              maintaskid: mainTaskId,
              title: '新しいタスク',
              startdate: startDate,
              enddate: endDate,
              status: 'pending',
              priority: 'medium',
              notes: '',
              progress: 0
            };

            const { error } = await supabase
              .from('tasks')
              .insert([newTask]);

            if (error) throw error;

            this.data.tasks.push(newTask);
          } catch (error) {
            console.error('タスク追加エラー:', error);
            alert('タスクの追加に失敗しました');
          }
        },
        // タスクバーのドラッグ開始
        startDraggingTask(e, task) {
          e.stopPropagation();
          this.draggingTask = task;
          this.dragStartX = e.clientX;
          this.dragStartDate = new Date(task.startdate);
        },
        // タスクバーのリサイズ開始
        startResizingTask(e, task) {
          e.stopPropagation();
          this.resizingTask = task;
          this.dragStartX = e.clientX;
          const start = new Date(task.startdate);
          const end = new Date(task.enddate);
          this.resizeStartWidth = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
        },
        // マウス移動処理
        onMouseMove(e) {
          if (this.draggingTask) {
            const deltaX = e.clientX - this.dragStartX;
            const deltaDays = Math.round(deltaX / 32);

            const newStartDate = new Date(this.dragStartDate);
            newStartDate.setDate(newStartDate.getDate() + deltaDays);

            const taskDuration = Math.floor((new Date(this.draggingTask.enddate) - new Date(this.draggingTask.startdate)) / (1000 * 60 * 60 * 24));
            const newEndDate = new Date(newStartDate);
            newEndDate.setDate(newEndDate.getDate() + taskDuration);

            this.draggingTask.startdate = newStartDate.toISOString().split('T')[0];
            this.draggingTask.enddate = newEndDate.toISOString().split('T')[0];
          } else if (this.resizingTask) {
            const deltaX = e.clientX - this.dragStartX;
            const deltaDays = Math.round(deltaX / 32);
            const newWidth = Math.max(1, this.resizeStartWidth + deltaDays);

            const newEndDate = new Date(this.resizingTask.startdate);
            newEndDate.setDate(newEndDate.getDate() + newWidth - 1);

            this.resizingTask.enddate = newEndDate.toISOString().split('T')[0];
          }
        },
        // マウスボタン解放処理
        async onMouseUp() {
          if (this.draggingTask) {
            await this.saveTaskDates(this.draggingTask);
            this.draggingTask = null;
          } else if (this.resizingTask) {
            await this.saveTaskDates(this.resizingTask);
            this.resizingTask = null;
          }
        },
        // タスクの日付を保存
        async saveTaskDates(task) {
          try {
            await supabase
              .from('tasks')
              .update({ startdate: task.startdate, enddate: task.enddate })
              .eq('id', task.id);
          } catch (error) {
            console.error('日付保存エラー:', error);
            alert('日付の保存に失敗しました');
          }
        }
      },
      watch: {
        selectedTaskForDetail(newVal) {
          if (newVal) {
            this.editingTask = { ...newVal };
          }
        }
      },
      mounted() {
        this.loadData();
        // マウスイベントリスナーを追加
        document.addEventListener('mousemove', this.onMouseMove);
        document.addEventListener('mouseup', this.onMouseUp);
      },
      beforeUnmount() {
        // イベントリスナーを削除
        document.removeEventListener('mousemove', this.onMouseMove);
        document.removeEventListener('mouseup', this.onMouseUp);
      }
    }).mount('#app');
  </script>
</body>
</html>
