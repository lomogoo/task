<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é«˜æ©Ÿèƒ½ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚¢ãƒ—ãƒª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/ja.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®ã‚°ãƒªãƒƒãƒ‰å®šç¾© */
    .gantt-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      /* å·¦ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«å›ºå®šå¹… + å¯å¤‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
      height: calc(100vh - 64px);
      /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†å¼•ã */
      overflow: auto;
      position: relative;
      align-content: start;
    }

    /* å·¦å´ã®å›ºå®šåˆ—ï¼ˆå·¥ç¨‹åï¼‰ */
    .sticky-col {
      position: sticky;
      left: 0;
      background: white;
      z-index: 20;
      border-right: 2px solid #e5e7eb;
    }

    /* ä¸Šéƒ¨ã®å›ºå®šè¡Œï¼ˆæ—¥ä»˜ï¼‰ */
    .sticky-header {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 10;
      border-bottom: 1px solid #e5e7eb;
    }

    /* å·¦ä¸Šã®äº¤å·®éƒ¨åˆ†ï¼ˆä¸€ç•ªæ‰‹å‰ã«è¡¨ç¤ºï¼‰ */
    .sticky-corner {
      position: sticky;
      top: 0;
      left: 0;
      z-index: 30;
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
      border-right: 2px solid #e5e7eb;
    }

    /* ã‚¿ã‚¹ã‚¯ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .task-bar {
      transition: all 0.2s;
      cursor: grab;
    }

    .task-bar:active {
      cursor: grabbing;
    }

    /* ä¼‘æ—¥èƒŒæ™¯ */
    .is-weekend {
      background-color: #fee2e2;
    }

    /* è–„ã„èµ¤ */
    .is-saturday {
      background-color: #eff6ff;
    }

    /* è–„ã„é’ */

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }

    /* ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ« */
    .resize-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: col-resize;
      z-index: 10;
    }

    .resize-handle-left {
      left: 0;
    }

    .resize-handle-right {
      right: 0;
    }

    /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
    .project-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .project-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* AIãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
    .chat-window {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      max-height: 600px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      max-height: 400px;
    }

    .chat-fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s;
      z-index: 99;
    }

    .chat-fab:hover {
      transform: scale(1.1);
    }

    .task-recommendation {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: transform 0.2s;
    }

    .task-recommendation:hover {
      transform: translateX(4px);
    }

    /* Remove infinite canvas styles */
    /* Removed infinite canvas styles
      width: 100%;
      height: calc(100vh - 64px);
      overflow: hidden;
      position: relative;
      background:
        linear-gradient(90deg, rgba(0, 0, 0, .03) 1px, transparent 1px),
        linear-gradient(rgba(0, 0, 0, .03) 1px, transparent 1px);
      background-size: 50px 50px;
      cursor: grab;
    }

    .infinite-canvas.dragging {
      cursor: grabbing;
    }

    .canvas-viewport {
      transform-origin: 0 0;
      transition: transform 0.1s ease-out;
    }

    .mind-node {
      position: absolute;
      min-width: 150px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      cursor: move;
      user-select: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .mind-node:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .gantt-zone {
      position: absolute;
      right: 0;
      top: 0;
      width: 60%;
      height: 100%;
      background: rgba(99, 102, 241, 0.05);
      border-left: 2px dashed rgba(99, 102, 241, 0.3);
    }

    .zoom-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      background: white;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    */
  </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">

  <header class="h-16 bg-white/80 backdrop-blur-md border-b flex items-center px-6 justify-between sticky top-0 z-50">
    <div class="flex items-center space-x-6">
      <h1
        class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 cursor-pointer hover:opacity-80 transition-opacity"
        onclick="showHome()">
        <i class="fas fa-stream mr-2 text-indigo-600"></i>Gantt Master
      </h1>

      <!-- Remove Labs Menu -->
      <nav class="hidden flex items-center space-x-1 text-sm">
        <button onclick="showHome()"
          class="px-3 py-1.5 rounded-lg hover:bg-gray-100 transition-colors text-gray-600">ãƒ›ãƒ¼ãƒ </button>
        <button onclick="showAIGenerator()"
          class="px-3 py-1.5 rounded-lg hover:bg-indigo-50 transition-colors text-indigo-600 font-medium"><i
            class="fas fa-wand-magic-sparkles mr-1"></i>AIç”Ÿæˆ</button>
        <button onclick="showInfiniteCanvas()"
          class="px-3 py-1.5 rounded-lg hover:bg-purple-50 transition-colors text-purple-600 font-medium"><i
            class="fas fa-infinity mr-1"></i>ã‚­ãƒ£ãƒ³ãƒã‚¹</button>
      </nav>

      <div id="navControls" class="hidden flex items-center space-x-3 bg-gray-100 rounded-full px-4 py-1.5">
        <div class="relative group">
          <select id="clientSelect"
            class="appearance-none bg-transparent font-medium text-gray-700 text-sm pr-6 focus:outline-none cursor-pointer">
            <option value="">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé¸æŠ...</option>
          </select>
          <i
            class="fas fa-chevron-down absolute right-0 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
        </div>
        <button onclick="openModal('client')" class="text-indigo-500 hover:text-indigo-700 transition-colors"><i
            class="fas fa-plus-circle"></i></button>

        <span class="text-gray-300">|</span>

        <div class="relative group">
          <select id="projectSelect"
            class="appearance-none bg-transparent font-medium text-gray-700 text-sm pr-6 focus:outline-none cursor-pointer disabled:text-gray-400"
            disabled>
            <option value="">æ¡ˆä»¶ã‚’é¸æŠ...</option>
          </select>
          <i
            class="fas fa-chevron-down absolute right-0 top-1/2 transform -translate-y-1/2 text-xs text-gray-400 pointer-events-none"></i>
        </div>
        <button id="addProjectBtn" onclick="openModal('project')"
          class="text-gray-400 cursor-not-allowed transition-colors" disabled><i
            class="fas fa-plus-circle"></i></button>
      </div>
    </div>

    <div class="flex items-center space-x-4">
      <button onclick="resetData()"
        class="text-xs text-red-400 hover:text-red-600 font-medium transition-colors">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
    </div>
  </header>

  <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ (ç›´è¿‘ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ) -->
  <div id="homeView" class="container mx-auto px-6 py-12">
    <div class="flex justify-between items-center mb-6">
      <div>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome Back</h2>
        <p class="text-gray-500" id="todayDate"></p>
      </div>
      <div class="space-x-2">
        <button onclick="openModal('client')"
          class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
          <i class="fas fa-user-plus mr-2"></i>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¿½åŠ 
        </button>
        <button onclick="openModal('project')"
          class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
          id="homeAddProjectBtn">
          <i class="fas fa-folder-plus mr-2"></i>æ¡ˆä»¶è¿½åŠ 
        </button>
      </div>
    </div>

    <!-- ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ -->
    <div id="todayRecommendations" class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-star text-yellow-500 mr-2"></i>ä»Šæ—¥ã™ã¹ãã“ã¨</h3>
      <div id="recommendationsList">
        <!-- JSã§ç”Ÿæˆ -->
      </div>
    </div>

    <h3 class="text-xl font-bold text-gray-800 mb-4">æœ€è¿‘ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h3>
    <div id="recentProjectsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- JSã§ç”Ÿæˆ -->
    </div>

    <div id="noRecentProjects" class="hidden text-center py-20 text-gray-400">
      <i class="fas fa-folder-open text-6xl mb-4 opacity-50"></i>
      <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨æ¡ˆä»¶ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
    </div>
  </div>

  <main id="mainArea" class="relative hidden">
    <!-- æ¡ˆä»¶æƒ…å ±ã‚¨ãƒªã‚¢ -->
    <div id="projectInfoArea" class="bg-white border-b px-6 py-4 hidden">
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-2">
            <h2 id="infoProjectName" class="text-2xl font-bold text-gray-800">æ¡ˆä»¶å</h2>
            <button onclick="openProjectInfoModal()" class="text-gray-400 hover:text-indigo-600 text-sm"><i
                class="fas fa-pen"></i> ç·¨é›†</button>
          </div>
          <p id="infoOverview" class="text-sm text-gray-600 mb-2">æ¡ˆä»¶ã®æ¦‚è¦ãŒã“ã“ã«å…¥ã‚Šã¾ã™ã€‚</p>
          <div class="flex items-center gap-4 text-xs text-gray-500">
            <span class="flex items-center gap-1"><i class="fas fa-users"></i> <span id="infoStakeholders">ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼:
                æœªè¨­å®š</span></span>
            <span class="flex items-center gap-1"><i class="far fa-calendar-alt"></i> <span id="infoPeriod">æœŸé–“:
                è‡ªå‹•è¨ˆç®—</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»æ¡ˆä»¶ä¸€è¦§ -->
    <div class="mb-12">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-folder-open text-indigo-500 mr-3"></i>Projects
        </h2>
        <div class="flex space-x-3">
          <button onclick="openModal('client')"
            class="text-sm bg-white border border-gray-200 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
            <i class="fas fa-plus mr-2"></i>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
          </button>
          <button onclick="openModal('project')"
            class="text-sm bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
            <i class="fas fa-plus mr-2"></i>æ¡ˆä»¶
          </button>
        </div>
      </div>

      <div id="clientProjectList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- JavaScriptã§ã“ã“ã«ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ç©ºã®çŠ¶æ…‹ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼‰ -->
    <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-gray-400">
      <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
        <i class="fas fa-cube text-4xl text-gray-300"></i>
      </div>
      <p class="text-lg font-medium text-gray-500">ã¾ã ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
      <p class="text-sm text-gray-400 mt-2">å³ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨æ¡ˆä»¶ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
    </div>

    <div id="ganttView" class="hidden gantt-container shadow-inner bg-white">
    </div>
  </main>

  <!-- AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ -->
  <div id="chatFAB" class="chat-fab" onclick="toggleChat()">
    <i class="fas fa-robot"></i>
  </div>

  <div id="chatWindow" class="chat-window hidden">
    <div class="bg-indigo-600 text-white p-4 rounded-t-2xl flex justify-between items-center shadow-md">
      <div class="flex items-center">
        <i class="fas fa-robot mr-2 text-xl"></i>
        <span class="font-bold text-lg tracking-wide">AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</span>
      </div>
      <div class="flex items-center space-x-2">
        <button onclick="changeApiKey()" class="text-white/80 hover:text-white transition-colors p-1" title="APIã‚­ãƒ¼è¨­å®š">
          <i class="fas fa-cog"></i>
        </button>
        <button onclick="toggleChat()" class="text-white/80 hover:text-white transition-colors p-1">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="text-center text-gray-400 text-sm py-8">
        <i class="fas fa-comments text-4xl mb-2"></i>
        <p>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„</p>
      </div>
    </div>

    <div class="p-4 border-t">
      <div class="flex gap-2">
        <input type="text" id="chatInput" placeholder="è³ªå•ã‚’å…¥åŠ›..."
          class="flex-1 border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
          onkeydown="if(event.key==='Enter') sendChatMessage()">
        <button onclick="sendChatMessage()"
          class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      <div class="text-xs text-gray-400 mt-2">
        ä¾‹: ã€Œä»Šé€±ç· ã‚åˆ‡ã‚Šã®ã‚¿ã‚¹ã‚¯ã¯ï¼Ÿã€ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆAã®é€²æ—ã¯ï¼Ÿã€
      </div>
    </div>
  </div>

  <!-- Gemini APIã‚­ãƒ¼å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl w-[500px] p-6 transform transition-all scale-100">
      <h3 class="text-xl font-bold mb-4 text-gray-800">
        <i class="fas fa-key text-indigo-600 mr-2"></i>Gemini API ã‚­ãƒ¼è¨­å®š
      </h3>
      <p class="text-sm text-gray-600 mb-4">
        AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Google Gemini API ã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚<br>
        <strong>å®Œå…¨ç„¡æ–™</strong>ã§å–å¾—ã§ãã¾ã™ï¼
      </p>

      <div class="bg-indigo-50 border-l-4 border-indigo-600 p-4 mb-4 text-sm">
        <p class="font-bold text-indigo-800 mb-2">ğŸ“ APIã‚­ãƒ¼å–å¾—æ–¹æ³•ï¼ˆ2åˆ†ã§å®Œäº†ï¼‰</p>
        <ol class="list-decimal list-inside space-y-1 text-indigo-900">
          <li><a href="https://aistudio.google.com/app/apikey" target="_blank"
              class="underline hover:text-indigo-600">Google AI Studio</a> ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
          <li>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</li>
          <li>ã€ŒAPIã‚­ãƒ¼ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
          <li>ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</li>
          <li>ä¸‹ã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘</li>
        </ol>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">APIã‚­ãƒ¼</label>
        <input type="text" id="geminiApiKeyInput"
          class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-mono"
          placeholder="AIza...ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„">
      </div>

      <div class="flex justify-end space-x-3">
        <button onclick="closeApiKeyModal()"
          class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="saveApiKey()"
          class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md transition-colors">
          <i class="fas fa-save mr-2"></i>ä¿å­˜ã—ã¦ä½¿ç”¨
        </button>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  </div>
  <div id="projectInfoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl w-[500px] p-6 transform transition-all scale-100">
      <h3 class="text-xl font-bold mb-4 text-gray-800">æ¡ˆä»¶æƒ…å ±ã®ç·¨é›†</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ¡ˆä»¶æ¦‚è¦</label>
          <textarea id="editProjectOverview"
            class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
            rows="3"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼</label>
          <input type="text" id="editProjectStakeholders"
            class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none text-sm"
            placeholder="ä¾‹: å–¶æ¥­éƒ¨, ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆAæ°">
        </div>
      </div>
      <div class="flex justify-end space-x-3 mt-6">
        <button
          onclick="document.getElementById('projectInfoModal').classList.add('hidden'); document.getElementById('projectInfoModal').classList.remove('flex')"
          class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="saveProjectInfo()"
          class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-md transition-colors">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="inputModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-96 p-6">
      <h3 id="modalTitle" class="text-lg font-bold mb-4 text-gray-700">è¿½åŠ </h3>
      <input type="hidden" id="modalType">
      <input type="hidden" id="modalParentId">

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">åç§° / ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input type="text" id="modalNameInput"
          class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none">
      </div>

      <div id="taskFields" class="hidden space-y-4">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-sm text-gray-600">é–‹å§‹æ—¥</label>
            <input type="date" id="modalStartDate" class="w-full border rounded p-1 text-sm">
          </div>
          <div>
            <label class="block text-sm text-gray-600">çµ‚äº†æ—¥</label>
            <input type="date" id="modalEndDate" class="w-full border rounded p-1 text-sm">
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <div class="flex space-x-2">
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="modalStatus" value="0" class="peer hidden" checked>
              <div
                class="text-center py-2 rounded border peer-checked:bg-gray-500 peer-checked:text-white peer-checked:border-gray-500 text-xs text-gray-600 hover:bg-gray-50 transition-colors">
                æœªç€æ‰‹</div>
            </label>
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="modalStatus" value="1" class="peer hidden">
              <div
                class="text-center py-2 rounded border peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 text-xs text-gray-600 hover:bg-blue-50 transition-colors">
                é€²è¡Œä¸­</div>
            </label>
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="modalStatus" value="2" class="peer hidden">
              <div
                class="text-center py-2 rounded border peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500 text-xs text-gray-600 hover:bg-green-50 transition-colors">
                å®Œäº†</div>
            </label>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-600">ãƒ¡ãƒ¢</label>
          <textarea id="modalMemo" class="w-full border rounded p-2 text-sm" rows="3"></textarea>
        </div>
      </div>

      <div class="flex justify-end space-x-2 mt-6">
        <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="submitModal()"
          class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // --- 1. SupabaseåˆæœŸåŒ– ---
    const SUPABASE_URL = 'https://dsuiaaaxwwvhiqktgvoi.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzdWlhYWF4d3d2aGlxa3Rndm9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxODcxODQsImV4cCI6MjA3ODc2MzE4NH0.ng7SlvSE25Ef_EZZeTe5F2tGcHNco1x1iZ_Nx4ewohg';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Gemini API Key (localStorageã«ä¿å­˜)
    let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';

    // --- 2. ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    dayjs.locale('ja');
    const CELL_WIDTH = 40;

    let store = {
      clients: [],
      projects: [],
      majorCats: [],
      minorCats: [],
      tasks: []
    };

    let currentClientId = null;
    let currentProjectId = null;

    // --- 3. Supabase CRUDæ“ä½œ ---
    async function loadAllData() {
      try {
        const [clients, projects, majors, minors, tasks] = await Promise.all([
          supabaseClient.from('clients').select('*').order('created_at'),
          supabaseClient.from('projects').select('*').order('created_at'),
          supabaseClient.from('major_cats').select('*').order('sort_order'),
          supabaseClient.from('minor_cats').select('*').order('sort_order'),
          supabaseClient.from('tasks').select('*').order('created_at')
        ]);

        store.clients = clients.data || [];
        store.projects = projects.data || [];
        store.majorCats = majors.data || [];
        store.minorCats = minors.data || [];
        store.tasks = tasks.data || [];

        renderApp();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function saveClient(name) {
      const { data, error } = await supabaseClient.from('clients').insert({ name }).select();
      if (error) throw error;
      return data[0];
    }

    async function saveProject(clientId, name) {
      const { data, error } = await supabaseClient.from('projects')
        .insert({ client_id: clientId, name }).select();
      if (error) throw error;
      return data[0];
    }

    async function saveMajorCat(projectId, name) {
      const { data, error } = await supabaseClient.from('major_cats')
        .insert({ project_id: projectId, name }).select();
      if (error) throw error;
      return data[0];
    }

    async function saveMinorCat(majorId, name) {
      const { data, error } = await supabaseClient.from('minor_cats')
        .insert({ major_id: majorId, name }).select();
      if (error) throw error;
      return data[0];
    }

    async function saveTask(task) {
      const { data, error } = await supabaseClient.from('tasks')
        .insert({
          minor_id: task.minorId,
          name: task.name,
          start_date: task.startDate,
          end_date: task.endDate,
          status: task.status,
          memo: task.memo
        }).select();
      if (error) throw error;
      return data[0];
    }

    async function updateTask(id, updates) {
      const dbUpdates = {};
      if (updates.name) dbUpdates.name = updates.name;
      if (updates.startDate) dbUpdates.start_date = updates.startDate;
      if (updates.endDate) dbUpdates.end_date = updates.endDate;
      if (updates.status !== undefined) dbUpdates.status = updates.status;
      if (updates.memo !== undefined) dbUpdates.memo = updates.memo;
      if (updates.minorId) dbUpdates.minor_id = updates.minorId;

      const { error } = await supabaseClient.from('tasks').update(dbUpdates).eq('id', id);
      if (error) throw error;
    }

    async function updateProjectInfo(id, overview, stakeholders) {
      const { error } = await supabaseClient.from('projects')
        .update({ overview, stakeholders }).eq('id', id);
      if (error) throw error;
    }

    async function resetData() {
      if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        await Promise.all([
          supabaseClient.from('tasks').delete().neq('id', '00000000-0000-0000-0000-000000000000'),
          supabaseClient.from('minor_cats').delete().neq('id', '00000000-0000-0000-0000-000000000000'),
          supabaseClient.from('major_cats').delete().neq('id', '00000000-0000-0000-0000-000000000000'),
          supabaseClient.from('projects').delete().neq('id', '00000000-0000-0000-0000-000000000000'),
          supabaseClient.from('clients').delete().neq('id', '00000000-0000-0000-0000-000000000000')
        ]);
        location.reload();
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // --- 4. åˆæœŸåŒ– ---
    window.onload = async () => {
      await loadAllData();
      renderClientSelect();
      setupEventListeners();
      showHome();
      displayTodayDate();
    };

    function displayTodayDate() {
      const today = dayjs();
      document.getElementById('todayDate').textContent = today.format('YYYYå¹´MæœˆDæ—¥ (dd)');
    }

    function setupEventListeners() {
      document.getElementById('clientSelect').addEventListener('change', (e) => {
        currentClientId = e.target.value;
        currentProjectId = null;
        renderProjectSelect();
        toggleGanttView(false);
      });

      document.getElementById('projectSelect').addEventListener('change', (e) => {
        currentProjectId = e.target.value;
        toggleGanttView(!!currentProjectId);
        if (currentProjectId) renderGantt();
      });

      // Enter support for modals
      const inputs = document.querySelectorAll('#inputModal input, #inputModal textarea');
      inputs.forEach(input => {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            submitModal();
          }
        });
      });
    }

    function showHome() {
      document.getElementById('homeView').classList.remove('hidden');
      document.getElementById('mainArea').classList.add('hidden');
      document.getElementById('navControls').classList.add('hidden');
      renderRecentProjects();
      renderTodayRecommendations();
    }

    function showGantt() {
      document.getElementById('homeView').classList.add('hidden');
      document.getElementById('mainArea').classList.remove('hidden');
      document.getElementById('navControls').classList.remove('hidden');
    }

    // --- 5. ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ ---
    function renderTodayRecommendations() {
      const today = dayjs();
      const container = document.getElementById('recommendationsList');

      const todayTasks = store.tasks.filter(t => {
        const start = dayjs(t.start_date);
        const end = dayjs(t.end_date);
        return today.isBetween(start, end, 'day', '[]') && t.status !== 2;
      });

      if (todayTasks.length === 0) {
        container.innerHTML = '<div class="text-gray-400 text-sm">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = '';
      todayTasks.slice(0, 5).forEach(task => {
        const minor = store.minorCats.find(m => m.id === task.minor_id);
        const major = minor ? store.majorCats.find(maj => maj.id === minor.major_id) : null;
        const project = major ? store.projects.find(p => p.id === major.project_id) : null;

        const card = document.createElement('div');
        card.className = 'task-recommendation cursor-pointer';
        card.onclick = () => {
          if (project) loadProject(project.client_id, project.id);
        };
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="font-bold text-lg">${task.name}</div>
              <div class="text-xs opacity-90 mt-1">
                ${project ? project.name : ''} â†’ ${major ? major.name : ''} â†’ ${minor ? minor.name : ''}
              </div>
            </div>
            <div class="text-xs opacity-75">
              ${task.status === 0 ? 'æœªç€æ‰‹' : 'é€²è¡Œä¸­'}
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // --- 6. æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
    function renderClientSelect() {
      const select = document.getElementById('clientSelect');
      select.innerHTML = '<option value="">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé¸æŠ...</option>';
      store.clients.forEach(c => {
        const op = document.createElement('option');
        op.value = c.id;
        op.innerText = c.name;
        if (c.id === currentClientId) op.selected = true;
        select.appendChild(op);
      });
    }

    function renderProjectSelect() {
      const select = document.getElementById('projectSelect');
      const addBtn = document.getElementById('addProjectBtn');
      select.innerHTML = '<option value="">æ¡ˆä»¶ã‚’é¸æŠ...</option>';

      if (!currentClientId) {
        select.disabled = true;
        addBtn.classList.add('cursor-not-allowed', 'text-gray-400');
        addBtn.disabled = true;
        return;
      }

      select.disabled = false;
      addBtn.classList.remove('cursor-not-allowed', 'text-gray-400');
      addBtn.classList.add('text-indigo-600');
      addBtn.disabled = false;

      const projects = store.projects.filter(p => p.client_id === currentClientId);
      projects.forEach(p => {
        const op = document.createElement('option');
        op.value = p.id;
        op.innerText = p.name;
        if (p.id === currentProjectId) op.selected = true;
        select.appendChild(op);
      });
    }

    function renderClientProjectList() {
      const container = document.getElementById('clientProjectList');
      const emptyState = document.getElementById('emptyState');

      if (store.clients.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        emptyState.classList.add('flex');
        return;
      }

      emptyState.classList.add('hidden');
      emptyState.classList.remove('flex');

      let html = '';

      store.clients.forEach(client => {
        const clientProjects = store.projects.filter(p => p.client_id === client.id);

        html += `
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-all duration-300 group">
            <div class="p-5 border-b border-gray-50 bg-gray-50/50 flex justify-between items-center">
              <h3 class="font-bold text-gray-800 truncate flex items-center">
                <i class="fas fa-building text-gray-400 mr-2 text-sm"></i>
                ${client.name}
              </h3>
              <span class="text-xs font-medium bg-white border border-gray-200 text-gray-500 px-2 py-1 rounded-full">
                ${clientProjects.length} æ¡ˆä»¶
              </span>
            </div>
            
            <div class="p-2">
              ${clientProjects.length > 0 ? `
                <div class="space-y-1">
                  ${clientProjects.map(project => {
          // é€²æ—çŠ¶æ³ã®ç°¡æ˜“è¨ˆç®—ï¼ˆå®Œäº†ã‚¿ã‚¹ã‚¯ / å…¨ã‚¿ã‚¹ã‚¯ï¼‰
          const pTasks = store.tasks.filter(t => {
            const minor = store.minorCats.find(m => m.id === t.minor_id);
            const major = minor ? store.majorCats.find(maj => maj.id === minor.major_id) : null;
            return major && major.project_id === project.id;
          });
          const doneTasks = pTasks.filter(t => t.status === 2).length;
          const progress = pTasks.length > 0 ? Math.round((doneTasks / pTasks.length) * 100) : 0;

          return `
                    <div onclick="loadProject('${project.id}')" 
                         class="group/item flex items-center justify-between p-3 rounded-lg hover:bg-indigo-50 cursor-pointer transition-colors">
                      <div class="flex-1 min-w-0 mr-3">
                        <div class="font-medium text-gray-700 text-sm truncate group-hover/item:text-indigo-700 transition-colors">
                          ${project.name}
                        </div>
                        <div class="flex items-center mt-1 space-x-3">
                          <div class="flex-1 h-1 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-indigo-400 rounded-full" style="width: ${progress}%"></div>
                          </div>
                          <span class="text-[10px] text-gray-400 font-mono">${progress}%</span>
                        </div>
                      </div>
                      <i class="fas fa-chevron-right text-gray-300 text-xs group-hover/item:text-indigo-400 transition-colors"></i>
                    </div>
                    `;
        }).join('')}
                </div>
              ` : `
                <div class="text-center py-6">
                  <p class="text-xs text-gray-400 mb-3">æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</p>
                  <button onclick="currentClientId='${client.id}'; openModal('project')" 
                          class="text-xs text-indigo-600 hover:text-indigo-800 font-medium hover:underline">
                    + æ¡ˆä»¶ã‚’è¿½åŠ 
                  </button>
                </div>
              `}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function loadProject(cId, pId) {
      currentClientId = cId;
      currentProjectId = pId;
      renderClientSelect();
      renderProjectSelect();
      showGantt();
      toggleGanttView(true);
      renderGantt();
    }

    function toggleGanttView(show) {
      const empty = document.getElementById('emptyState');
      const gantt = document.getElementById('ganttView');
      const info = document.getElementById('projectInfoArea');

      if (show) {
        empty.classList.add('hidden');
        gantt.classList.remove('hidden');
        info.classList.remove('hidden');
        updateProjectInfoArea();
      } else {
        empty.classList.remove('hidden');
        gantt.classList.add('hidden');
        info.classList.add('hidden');
      }
    }

    function updateProjectInfoArea() {
      const p = store.projects.find(x => x.id === currentProjectId);
      if (!p) return;
      document.getElementById('infoProjectName').innerText = p.name;
      document.getElementById('infoOverview').innerText = p.overview || 'æ¡ˆä»¶ã®æ¦‚è¦ã¯æœªè¨­å®šã§ã™ã€‚';
      document.getElementById('infoStakeholders').innerText = p.stakeholders || 'æœªè¨­å®š';
    }

    async function openProjectInfoModal() {
      const p = store.projects.find(x => x.id === currentProjectId);
      if (!p) return;
      document.getElementById('editProjectOverview').value = p.overview || '';
      document.getElementById('editProjectStakeholders').value = p.stakeholders || '';

      const m = document.getElementById('projectInfoModal');
      m.classList.remove('hidden');
      m.classList.add('flex');
    }

    async function saveProjectInfo() {
      const p = store.projects.find(x => x.id === currentProjectId);
      if (!p) return;

      const overview = document.getElementById('editProjectOverview').value;
      const stakeholders = document.getElementById('editProjectStakeholders').value;

      try {
        await updateProjectInfo(p.id, overview, stakeholders);
        p.overview = overview;
        p.stakeholders = stakeholders;
        updateProjectInfoArea();
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      document.getElementById('projectInfoModal').classList.add('hidden');
      document.getElementById('projectInfoModal').classList.remove('flex');
    }

    // --- 7. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæç”» ---
    function renderGantt() {
      const container = document.getElementById('ganttView');
      container.innerHTML = '';

      const majors = store.majorCats.filter(m => m.project_id === currentProjectId);
      const minorsMap = {};
      majors.forEach(m => {
        minorsMap[m.id] = store.minorCats.filter(mi => mi.major_id === m.id);
      });

      let allTasks = [];
      Object.values(minorsMap).flat().forEach(mi => {
        const tasks = store.tasks.filter(t => t.minor_id === mi.id);
        allTasks = allTasks.concat(tasks);
      });

      let startDate, endDate;
      if (allTasks.length > 0) {
        const dates = allTasks.flatMap(t => [dayjs(t.start_date), dayjs(t.end_date)]);
        const minDate = dates.reduce((a, b) => a.isBefore(b) ? a : b);
        const maxDate = dates.reduce((a, b) => a.isAfter(b) ? a : b);
        startDate = minDate.subtract(1, 'week');
        endDate = maxDate.add(1, 'week');
      } else {
        startDate = dayjs().subtract(1, 'week');
        endDate = dayjs().add(2, 'weeks');
      }

      const totalDays = endDate.diff(startDate, 'day') + 1;

      // Corner
      const corner = document.createElement('div');
      corner.className = 'sticky-corner p-2 flex items-center justify-between font-bold text-sm text-gray-600 h-12';
      corner.innerHTML = `
        <span>å·¥ç¨‹ä¸€è¦§</span>
        <button onclick="openModal('major')" class="text-indigo-600 hover:bg-indigo-100 p-1 rounded"><i class="fas fa-plus"></i></button>
      `;
      container.appendChild(corner);

      // Date header
      const dateHeader = document.createElement('div');
      dateHeader.className = 'sticky-header flex';
      dateHeader.style.width = `${totalDays * CELL_WIDTH}px`;

      for (let i = 0; i < totalDays; i++) {
        const d = startDate.add(i, 'day');
        const cell = document.createElement('div');
        cell.style.width = `${CELL_WIDTH}px`;
        cell.className = `flex-shrink-0 text-center text-xs border-r border-gray-200 flex flex-col justify-center items-center h-12 ${getDateColorClass(d)}`;

        const showMonth = (i === 0 || d.date() === 1);
        const monthText = showMonth ? d.format('Mæœˆ') : '&nbsp;';
        const monthClass = showMonth ? 'text-indigo-600' : 'invisible';

        cell.innerHTML = `
          <div class="text-[10px] ${monthClass} font-bold leading-none mb-0.5">${monthText}</div>
          <div class="font-bold leading-none">${d.format('D')}</div>
          <div class="text-[10px] text-gray-500 leading-none mt-0.5">${d.format('dd')}</div>
        `;
        dateHeader.appendChild(cell);
      }
      container.appendChild(dateHeader);

      // Body
      majors.forEach(major => {
        const minors = minorsMap[major.id];

        const majorRowLeft = document.createElement('div');
        majorRowLeft.className = 'sticky-col bg-gray-100 border-b border-gray-300 p-2 font-bold text-gray-700 flex justify-between items-center h-12 cursor-move';
        majorRowLeft.innerText = major.name;
        majorRowLeft.innerHTML += `<button onclick="openModal('minor', '${major.id}')" class="text-xs bg-white border px-1 rounded text-gray-500 hover:text-indigo-600 ml-2"><i class="fas fa-plus"></i> å°åˆ†é¡</button>`;

        majorRowLeft.draggable = true;
        majorRowLeft.ondragstart = (e) => handleRowDragStart(e, 'major', major.id);
        majorRowLeft.ondragover = (e) => e.preventDefault();
        majorRowLeft.ondrop = (e) => handleRowDrop(e, 'major', major.id);

        container.appendChild(majorRowLeft);

        const majorRowRight = document.createElement('div');
        majorRowRight.className = 'border-b border-gray-300 bg-gray-100 h-12';
        container.appendChild(majorRowRight);

        minors.forEach(minor => {
          const minorLeft = document.createElement('div');
          minorLeft.className = 'sticky-col border-b border-gray-200 p-2 pl-6 text-sm flex items-center justify-between h-12 cursor-move';
          minorLeft.innerHTML = `<span>${minor.name}</span> <i class="fas fa-chevron-right text-gray-300 text-xs"></i>`;

          minorLeft.draggable = true;
          minorLeft.ondragstart = (e) => handleRowDragStart(e, 'minor', minor.id);
          minorLeft.ondragover = (e) => e.preventDefault();
          minorLeft.ondrop = (e) => handleRowDrop(e, 'minor', minor.id);

          container.appendChild(minorLeft);

          const rowRight = document.createElement('div');
          rowRight.className = 'relative flex h-12 border-b border-gray-200';
          rowRight.style.width = `${totalDays * CELL_WIDTH}px`;

          for (let i = 0; i < totalDays; i++) {
            const d = startDate.add(i, 'day');
            const cell = document.createElement('div');
            cell.style.width = `${CELL_WIDTH}px`;
            cell.className = `flex-shrink-0 h-full border-r border-gray-100 ${getDateColorClass(d)} hover:bg-indigo-50 transition-colors cursor-pointer`;
            cell.onclick = () => openTaskModal(null, minor.id, d.format('YYYY-MM-DD'));
            rowRight.appendChild(cell);
          }

          const tasks = store.tasks.filter(t => t.minor_id === minor.id);
          tasks.forEach(task => {
            const tStart = dayjs(task.start_date);
            const tEnd = dayjs(task.end_date);

            if (tEnd.isBefore(startDate) || tStart.isAfter(endDate)) return;

            const diffDays = tStart.diff(startDate, 'day');
            const duration = tEnd.diff(tStart, 'day') + 1;

            const leftPos = diffDays * CELL_WIDTH;
            const widthPos = duration * CELL_WIDTH;

            let bgClass = 'bg-gray-400';
            if (task.status == 1) bgClass = 'bg-blue-500';
            if (task.status == 2) bgClass = 'bg-green-500';

            const taskBar = document.createElement('div');
            taskBar.className = `absolute top-2 h-8 rounded shadow task-bar ${bgClass} text-white text-xs flex items-center px-2 overflow-hidden whitespace-nowrap group`;
            taskBar.style.left = `${leftPos}px`;
            taskBar.style.width = `${widthPos - 2}px`;
            taskBar.dataset.taskId = task.id;

            taskBar.innerHTML = `
              <div class="resize-handle resize-handle-left opacity-0 group-hover:opacity-100 bg-white/30" data-direction="left"></div>
              <span class="pointer-events-none select-none flex-1 text-center">${task.name}</span>
              <div class="resize-handle resize-handle-right opacity-0 group-hover:opacity-100 bg-white/30" data-direction="right"></div>
            `;
            if (task.memo) taskBar.title = task.memo;

            // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            const leftHandle = taskBar.querySelector('[data-direction="left"]');
            const rightHandle = taskBar.querySelector('[data-direction="right"]');

            leftHandle.addEventListener('mousedown', (e) => startResize(e, task.id, 'left', startDate));
            rightHandle.addEventListener('mousedown', (e) => startResize(e, task.id, 'right', startDate));

            // ã‚¿ã‚¹ã‚¯ãƒãƒ¼æœ¬ä½“ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ä»¥å¤–ï¼‰
            taskBar.addEventListener('mousedown', (e) => {
              if (e.target.classList.contains('resize-handle')) return;
              if (e.detail === 2) { // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯
                openTaskModal(task);
              } else {
                startTaskDrag(e, task, startDate, minor.id);
              }
            });

            rowRight.appendChild(taskBar);
          });

          container.appendChild(rowRight);
        });
      });
    }

    function getDateColorClass(d) {
      const day = d.day();
      const isHoliday = (d.month() === 0 && d.date() === 1) || (d.month() === 4 && d.date() === 3);

      if (isHoliday) return 'bg-red-100';
      if (day === 0) return 'is-weekend';
      if (day === 6) return 'is-saturday';
      return 'bg-white';
    }

    // --- 8. ã‚¿ã‚¹ã‚¯ãƒªã‚µã‚¤ã‚ºï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
    function startResize(e, taskId, direction, ganttStartDate) {
      e.stopPropagation();
      e.preventDefault();

      const task = store.tasks.find(t => t.id === taskId);
      if (!task) return;

      const startX = e.clientX;
      const originalStart = dayjs(task.start_date);
      const originalEnd = dayjs(task.end_date);

      const onMouseMove = (moveEvent) => {
        const diffX = moveEvent.clientX - startX;
        const diffDays = Math.round(diffX / CELL_WIDTH);

        if (diffDays === 0) return;

        if (direction === 'left') {
          const newStart = originalStart.add(diffDays, 'day');
          if (newStart.isAfter(originalEnd)) return;
          task.start_date = newStart.format('YYYY-MM-DD');
        } else {
          const newEnd = originalEnd.add(diffDays, 'day');
          if (newEnd.isBefore(originalStart)) return;
          task.end_date = newEnd.format('YYYY-MM-DD');
        }
        renderGantt();
      };

      const onMouseUp = async () => {
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
        await updateTask(task.id, { startDate: task.start_date, endDate: task.end_date });
        await loadAllData();
      };

      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);
    }

    // --- 9. ã‚¿ã‚¹ã‚¯ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
    function startTaskDrag(e, task, ganttStartDate, currentMinorId) {
      e.stopPropagation();

      const startX = e.clientX;
      const startY = e.clientY;
      let hasMoved = false;

      const taskBar = e.currentTarget;
      const originalLeft = parseInt(taskBar.style.left);

      const onMouseMove = (moveEvent) => {
        const diffX = moveEvent.clientX - startX;
        const diffY = moveEvent.clientY - startY;

        if (Math.abs(diffX) > 5 || Math.abs(diffY) > 5) {
          hasMoved = true;
        }

        if (hasMoved) {
          const daysOffset = Math.round(diffX / CELL_WIDTH);
          const duration = dayjs(task.end_date).diff(dayjs(task.start_date), 'day');
          const newStart = dayjs(task.start_date).add(daysOffset, 'day');

          task.start_date = newStart.format('YYYY-MM-DD');
          task.end_date = newStart.add(duration, 'day').format('YYYY-MM-DD');

          renderGantt();
        }
      };

      const onMouseUp = async (upEvent) => {
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);

        if (!hasMoved) return; // ã‚¯ãƒªãƒƒã‚¯ã®ã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„

        await updateTask(task.id, {
          startDate: task.start_date,
          endDate: task.end_date,
          minorId: currentMinorId
        });
        await loadAllData();
      };

      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);
    }

    // --- 10. è¡Œã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ---
    function handleRowDragStart(e, type, id) {
      e.dataTransfer.setData('type', type);
      e.dataTransfer.setData('dragId', id);
      e.stopPropagation();
    }

    function handleRowDrop(e, type, targetId) {
      e.preventDefault();
      e.stopPropagation();
      // çœç•¥ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨åŒæ§˜ï¼‰
    }

    function handleMinorDropOnMajor(e, targetMajorId) {
      e.preventDefault();
      e.stopPropagation();
      // çœç•¥ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨åŒæ§˜ï¼‰
    }

    // --- 11. ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
    let editingTaskId = null;

    function openModal(type, parentId = null) {
      editingTaskId = null;
      document.getElementById('inputModal').classList.remove('hidden');
      document.getElementById('inputModal').classList.add('flex');

      document.getElementById('modalType').value = type;
      document.getElementById('modalParentId').value = parentId || '';

      document.getElementById('modalNameInput').value = '';
      document.getElementById('taskFields').classList.add('hidden');

      let title = '';
      if (type === 'client') title = 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¿½åŠ ';
      if (type === 'project') title = 'æ¡ˆä»¶è¿½åŠ ';
      if (type === 'major') title = 'å¤§åˆ†é¡ (å·¥ç¨‹) è¿½åŠ ';
      if (type === 'minor') title = 'å°åˆ†é¡ è¿½åŠ ';

      document.getElementById('modalTitle').innerText = title;

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰é–‹ã„ãŸå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé¸æŠå¯èƒ½ã«
      if (type === 'project' && !currentClientId) {
        const clientSelectHTML = `
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé¸æŠ</label>
            <select id="modalClientSelect" class="w-full border rounded p-2">
              ${store.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
            </select>
          </div>
        `;
        const nameInput = document.getElementById('modalNameInput').parentElement;
        nameInput.insertAdjacentHTML('beforebegin', clientSelectHTML);
      }
    }

    function openTaskModal(task, minorId = null, dateStr = null) {
      document.getElementById('inputModal').classList.remove('hidden');
      document.getElementById('inputModal').classList.add('flex');
      document.getElementById('modalType').value = 'task';
      document.getElementById('taskFields').classList.remove('hidden');

      if (task) {
        editingTaskId = task.id;
        document.getElementById('modalTitle').innerText = 'ã‚¿ã‚¹ã‚¯ç·¨é›†';
        document.getElementById('modalNameInput').value = task.name;
        document.getElementById('modalStartDate').value = task.start_date;
        document.getElementById('modalEndDate').value = task.end_date;

        const radios = document.getElementsByName('modalStatus');
        radios.forEach(r => {
          if (r.value == task.status) r.checked = true;
        });

        document.getElementById('modalMemo').value = task.memo || '';
        document.getElementById('modalParentId').value = task.minor_id;
      } else {
        editingTaskId = null;
        document.getElementById('modalTitle').innerText = 'ã‚¿ã‚¹ã‚¯è¿½åŠ ';
        document.getElementById('modalNameInput').value = '';
        document.getElementById('modalStartDate').value = dateStr;
        document.getElementById('modalEndDate').value = dayjs(dateStr).add(1, 'day').format('YYYY-MM-DD');
        document.getElementsByName('modalStatus')[0].checked = true;
        document.getElementById('modalMemo').value = '';
        document.getElementById('modalParentId').value = minorId;
      }
    }

    function closeModal() {
      document.getElementById('inputModal').classList.add('hidden');
      document.getElementById('inputModal').classList.remove('flex');

      const clientSelect = document.getElementById('modalClientSelect');
      if (clientSelect) clientSelect.parentElement.remove();
    }

    async function submitModal() {
      const type = document.getElementById('modalType').value;
      const name = document.getElementById('modalNameInput').value;
      let parentId = document.getElementById('modalParentId').value;

      if (!name) { alert('åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      try {
        if (type === 'client') {
          await saveClient(name);
        } else if (type === 'project') {
          const clientSelect = document.getElementById('modalClientSelect');
          const clientId = clientSelect ? clientSelect.value : currentClientId;
          if (!clientId) { alert('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
          await saveProject(clientId, name);
        } else if (type === 'major') {
          await saveMajorCat(currentProjectId, name);
        } else if (type === 'minor') {
          await saveMinorCat(parentId, name);
        } else if (type === 'task') {
          const sDate = document.getElementById('modalStartDate').value;
          const eDate = document.getElementById('modalEndDate').value;

          let status = 0;
          document.getElementsByName('modalStatus').forEach(r => {
            if (r.checked) status = parseInt(r.value);
          });

          const memo = document.getElementById('modalMemo').value;

          if (dayjs(eDate).isBefore(dayjs(sDate))) {
            alert('çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ã‚ˆã‚Šå¾Œã«ã—ã¦ä¸‹ã•ã„');
            return;
          }

          if (editingTaskId) {
            await updateTask(editingTaskId, {
              name,
              startDate: sDate,
              endDate: eDate,
              status,
              memo
            });
          } else {
            await saveTask({
              minorId: parentId,
              name,
              startDate: sDate,
              endDate: eDate,
              status,
              memo
            });
          }
        }

        await loadAllData();
        closeModal();
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function renderApp() {
      if (currentClientId) renderClientSelect();
      if (currentProjectId) {
        renderProjectSelect();
        renderGantt();
      }
    }

    // --- 12. AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---
    let chatHistory = [];
    let pendingChatMessage = null;

    function toggleChat() {
      const fab = document.getElementById('chatFAB');
      const window = document.getElementById('chatWindow');

      if (window.classList.contains('hidden')) {
        window.classList.remove('hidden');
        fab.classList.add('hidden');
      } else {
        window.classList.add('hidden');
        fab.classList.remove('hidden');
      }
    }

    function changeApiKey() {
      GEMINI_API_KEY = '';
      localStorage.removeItem('gemini_api_key');
      openApiKeyModal();
    }

    function openApiKeyModal() {
      const modal = document.getElementById('apiKeyModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.getElementById('geminiApiKeyInput').value = GEMINI_API_KEY || '';
    }

    function closeApiKeyModal() {
      const modal = document.getElementById('apiKeyModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function saveApiKey() {
      const key = document.getElementById('geminiApiKeyInput').value.trim();
      if (!key) {
        alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      GEMINI_API_KEY = key;
      localStorage.setItem('gemini_api_key', key);
      closeApiKeyModal();

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ä¿ç•™ã—ã¦ã„ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°é€ä¿¡
      if (pendingChatMessage) {
        const msg = pendingChatMessage;
        pendingChatMessage = null;
        document.getElementById('chatInput').value = msg;
        sendChatMessage();
      }
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;

      if (!GEMINI_API_KEY) {
        pendingChatMessage = message;
        input.value = '';
        openApiKeyModal();
        return;
      }

      const messagesDiv = document.getElementById('chatMessages');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      appendChatMessage('user', message);
      input.value = '';

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      const loadingId = appendChatMessage('assistant', 'thinking...');

      try {
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æº–å‚™
        const context = {
          clients: store.clients.length,
          projects: store.projects.map(p => ({
            name: p.name,
            tasks: store.tasks.filter(t => {
              const minor = store.minorCats.find(m => m.id === t.minor_id);
              const major = minor ? store.majorCats.find(maj => maj.id === minor.major_id) : null;
              return major && major.project_id === p.id;
            }).length
          })),
          todayTasks: store.tasks.filter(t => {
            const today = dayjs();
            return today.isBetween(dayjs(t.start_date), dayjs(t.end_date), 'day', '[]') && t.status !== 2;
          }).map(t => ({
            name: t.name,
            status: t.status === 0 ? 'æœªç€æ‰‹' : 'é€²è¡Œä¸­',
            dueDate: t.end_date
          }))
        };

        // Gemini API v1beta - Verified working model
        // Using URL parameter for API key to avoid CORS/header issues in browser
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: `ã‚ãªãŸã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

ã€ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã€‘
${JSON.stringify(context, null, 2)}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã€‘
${message}

æ—¥æœ¬èªã§ç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚`
              }]
            }]
          })
        });

        if (!response.ok) {
          const errorData = await response.text();
          console.error('API Error Details:', errorData);
          throw new Error(`API Error: ${response.status} - ${errorData}`);
        }

        const data = await response.json();

        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
          throw new Error('Invalid API response structure');
        }

        const reply = data.candidates[0].content.parts[0].text;

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Ÿéš›ã®è¿”ä¿¡ã«ç½®ãæ›ãˆ
        document.getElementById(loadingId).innerHTML = marked(reply);

      } catch (error) {
        console.error('AI Error:', error);
        let errorMsg = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';

        if (error.message.includes('404')) {
          errorMsg += '<br>APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚æ­£ã—ã„ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        } else if (error.message.includes('API Error')) {
          errorMsg += `<br>${error.message}`;
        } else {
          errorMsg += '<br>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        }

        document.getElementById(loadingId).innerHTML = errorMsg;
      }
    }

    function appendChatMessage(role, content) {
      const messagesDiv = document.getElementById('chatMessages');
      const id = 'msg-' + Date.now();

      const msgDiv = document.createElement('div');
      msgDiv.id = id;
      msgDiv.className = role === 'user'
        ? 'mb-3 flex justify-end'
        : 'mb-3 flex justify-start';

      msgDiv.innerHTML = role === 'user'
        ? `<div class="bg-indigo-600 text-white px-4 py-2 rounded-lg max-w-xs">${content}</div>`
        : `<div class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg max-w-xs">${content}</div>`;

      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      return id;
    }

    // Marked.js alternative (simple markdown)
    function marked(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
      // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ ---
      window.openModal = openModal;
      window.closeModal = closeModal;
      window.submitModal = submitModal;
      window.resetData = resetData;
      window.showHome = showHome;
      window.loadProject = loadProject;
      window.openTaskModal = openTaskModal;
      window.openProjectInfoModal = openProjectInfoModal;
      window.saveProjectInfo = saveProjectInfo;
      window.toggleChat = toggleChat;
      window.sendChatMessage = sendChatMessage;
      window.openApiKeyModal = openApiKeyModal;
      window.closeApiKeyModal = closeApiKeyModal;
      window.saveApiKey = saveApiKey;
      window.changeApiKey = changeApiKey;
      window.renderClientProjectList = renderClientProjectList;
      window.handleMinorDropOnMajor = handleMinorDropOnMajor;
    }
  </script>
</body>

</html>